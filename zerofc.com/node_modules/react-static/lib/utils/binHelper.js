"use strict";

var path = require('path');

var _require = require('./'),
    escapeRegExp = _require.escapeRegExp;

var PrettyError = require('pretty-error');

var resolveFrom = require('resolve-from');

var Module = require('module'); // Allow as much stack tracing as possible


Error.stackTraceLimit = 10000;
var ignorePath;
var originalRequire = Module.prototype.require; // Check and see if we are running react-static from the repo

var needsWorkspaceCheck = __dirname.includes('/react-static/packages/react-static/'); // Recursively checks a module to see if it originated from a
// react-static package in the repo


var inRepo = function inRepo(mod) {
  if (!mod.filename.includes('react-static/packages/react-static/') && mod.filename.includes('react-static/packages/')) {
    return true;
  }

  if (mod.parent) {
    return inRepo(mod.parent);
  }

  return false;
}; // The following ensures that there is always only a single (and same)
// copy of React in an app at any given moment.
// eslint-disable-next-line


Module.prototype.require = function (modulePath) {
  // If we are running in the repo, we need to make sure
  // module resolutions coming from other react-static packages
  // are first attempted from the
  var isInWorkspace = needsWorkspaceCheck && inRepo(this); // Only redirect resolutions to non-relative and non-absolute modules

  if (!modulePath.startsWith('.') && !modulePath.startsWith('/')) {
    if ( // If module is in the repo try and redirect
    isInWorkspace || // Always try and redirect react and react-dom resolutions
    ['react', 'react-dom'].some(function (d) {
      return modulePath.includes(d);
    })) {
      try {
        modulePath = resolveFrom(path.resolve(process.cwd(), 'node_modules'), modulePath);
      } catch (err) {//
      }
    }
  }

  return originalRequire.call(this, modulePath);
};

require('@babel/register')({
  babelrc: false,
  presets: [[path.resolve(__dirname, '../../babel-preset.js'), {
    node: true
  }]],
  ignore: [function babelIgnore(filename) {
    // true if should ignore
    return new RegExp(escapeRegExp("".concat(path.sep, "node_modules").concat(path.sep))).test(filename) || ignorePath && ignorePath.test(filename);
  }]
}); // necesarry at any entry point of the cli to ensure that Babel-register
// does not attempt to transform non JavaScript files.


var ignoredExtensions = ['css', 'scss', 'styl', 'less', 'png', 'gif', 'jpg', 'jpeg', 'svg', 'woff', 'woff2', 'ttf', 'eot', 'otf', 'mp4', 'webm', 'ogg', 'mp3', 'wav', 'md', 'yaml'];
ignoredExtensions.forEach(function (ext) {
  require.extensions[".".concat(ext)] = function () {};
});

console.error = function (err) {
  var _console;

  for (var _len = arguments.length, rest = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    rest[_key - 1] = arguments[_key];
  }

  (_console = console).log.apply(_console, [new PrettyError().render(err)].concat(rest));
}; // Be sure to log useful information about unhandled exceptions. This should seriously
// be a default: https://github.com/nodejs/node/issues/9523#issuecomment-259303079


process.on('unhandledRejection', function (r) {
  console.error(r);
});
module.exports = {
  setIgnorePath: function setIgnorePath(path) {
    ignorePath = path ? new RegExp(escapeRegExp(path)) : undefined;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9iaW5IZWxwZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJlc2NhcGVSZWdFeHAiLCJQcmV0dHlFcnJvciIsInJlc29sdmVGcm9tIiwiTW9kdWxlIiwiRXJyb3IiLCJzdGFja1RyYWNlTGltaXQiLCJpZ25vcmVQYXRoIiwib3JpZ2luYWxSZXF1aXJlIiwicHJvdG90eXBlIiwibmVlZHNXb3Jrc3BhY2VDaGVjayIsIl9fZGlybmFtZSIsImluY2x1ZGVzIiwiaW5SZXBvIiwibW9kIiwiZmlsZW5hbWUiLCJwYXJlbnQiLCJtb2R1bGVQYXRoIiwiaXNJbldvcmtzcGFjZSIsInN0YXJ0c1dpdGgiLCJzb21lIiwiZCIsInJlc29sdmUiLCJwcm9jZXNzIiwiY3dkIiwiZXJyIiwiY2FsbCIsImJhYmVscmMiLCJwcmVzZXRzIiwibm9kZSIsImlnbm9yZSIsImJhYmVsSWdub3JlIiwiUmVnRXhwIiwic2VwIiwidGVzdCIsImlnbm9yZWRFeHRlbnNpb25zIiwiZm9yRWFjaCIsImV4dCIsImV4dGVuc2lvbnMiLCJjb25zb2xlIiwiZXJyb3IiLCJyZXN0IiwibG9nIiwicmVuZGVyIiwib24iLCJyIiwibW9kdWxlIiwiZXhwb3J0cyIsInNldElnbm9yZVBhdGgiLCJ1bmRlZmluZWQiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7ZUFDeUJBLE9BQU8sQ0FBQyxJQUFELEM7SUFBeEJDLFksWUFBQUEsWTs7QUFDUixJQUFNQyxXQUFXLEdBQUdGLE9BQU8sQ0FBQyxjQUFELENBQTNCOztBQUNBLElBQU1HLFdBQVcsR0FBR0gsT0FBTyxDQUFDLGNBQUQsQ0FBM0I7O0FBQ0EsSUFBTUksTUFBTSxHQUFHSixPQUFPLENBQUMsUUFBRCxDQUF0QixDLENBRUE7OztBQUNBSyxLQUFLLENBQUNDLGVBQU4sR0FBd0IsS0FBeEI7QUFFQSxJQUFJQyxVQUFKO0FBRUEsSUFBTUMsZUFBZSxH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d0IsRUFvQnhCLElBcEJ3QixFQXFCeEIsTUFyQndCLENBQTFCO0FBdUJBQSxpQkFBaUIsQ0FBQ0MsT0FBbEIsQ0FBMEIsVUFBQUMsR0FBRyxFQUFJO0FBQy9CckMsRUFBQUEsT0FBTyxDQUFDc0MsVUFBUixZQUF1QkQsR0FBdkIsS0FBZ0MsWUFBTSxDQUFFLENBQXhDO0FBQ0QsQ0FGRDs7QUFJQUUsT0FBTyxDQUFDQyxLQUFSLEdBQWdCLFVBQUNmLEdBQUQsRUFBa0I7QUFBQTs7QUFBQSxvQ0FBVGdCLElBQVM7QUFBVEEsSUFBQUEsSUFBUztBQUFBOztBQUNoQyxjQUFBRixPQUFPLEVBQUNHLEdBQVIsa0JBQVksSUFBSXhDLFdBQUosR0FBa0J5QyxNQUFsQixDQUF5QmxCLEdBQXpCLENBQVosU0FBOENnQixJQUE5QztBQUNELENBRkQsQyxDQUlBO0FBQ0E7OztBQUNBbEIsT0FBTyxDQUFDcUIsRUFBUixDQUFXLG9CQUFYLEVBQWlDLFVBQUFDLENBQUMsRUFBSTtBQUNwQ04sRUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWNLLENBQWQ7QUFDRCxDQUZEO0FBSUFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUNmQyxFQUFBQSxhQURlLHlCQUNEakQsSUFEQyxFQUNLO0FBQ2xCUSxJQUFBQSxVQUFVLEdBQUdSLElBQUksR0FBRyxJQUFJaUMsTUFBSixDQUFXL0IsWUFBWSxDQUFDRixJQUFELENBQXZCLENBQUgsR0FBb0NrRCxTQUFyRDtBQUNEO0FBSGMsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5jb25zdCB7IGVzY2FwZVJlZ0V4cCB9ID0gcmVxdWlyZSgnLi8nKVxuY29uc3QgUHJldHR5RXJyb3IgPSByZXF1aXJlKCdwcmV0dHktZXJyb3InKVxuY29uc3QgcmVzb2x2ZUZyb20gPSByZXF1aXJlKCdyZXNvbHZlLWZyb20nKVxuY29uc3QgTW9kdWxlID0gcmVxdWlyZSgnbW9kdWxlJylcblxuLy8gQWxsb3cgYXMgbXVjaCBzdGFjayB0cmFjaW5nIGFzIHBvc3NpYmxlXG5FcnJvci5zdGFja1RyYWNlTGltaXQgPSAxMDAwMFxuXG5sZXQgaWdub3JlUGF0aFxuXG5jb25zdCBvcmlnaW5hbFJlcXVpcmUgPSBNb2R1bGUucHJvdG90eXBlLnJlcXVpcmVcblxuLy8gQ2hlY2sgYW5kIHNlZSBpZiB3ZSBhcmUgcnVubmluZyByZWFjdC1zdGF0aWMgZnJvbSB0aGUgcmVwb1xuY29uc3QgbmVlZHNXb3Jrc3BhY2VDaGVjayA9IF9fZGlybmFtZS5pbmNsdWRlcyhcbiAgJy9yZWFjdC1zdGF0aWMvcGFja2FnZXMvcmVhY3Qtc3RhdGljLydcbilcblxuLy8gUmVjdXJzaXZlbHkgY2hlY2tzIGEgbW9kdWxlIHRvIHNlZSBpZiBpdCBvcmlnaW5hdGVkIGZyb20gYVxuLy8gcmVhY3Qtc3RhdGljIHBhY2thZ2UgaW4gdGhlIHJlcG9cbmNvbnN0IGluUmVwbyA9IG1vZCA9PiB7XG4gIGlmIChcbiAgICAhbW9kLmZpbGVuYW1lLmluY2x1ZGVzKCdyZWFjdC1zdGF0aWMvcGFja2FnZXMvcmVhY3Qtc3RhdGljLycpICYmXG4gICAgbW9kLmZpbGVuYW1lLmluY2x1ZGVzKCdyZWFjdC1zdGF0aWMvcGFja2FnZXMvJylcbiAgKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuICBpZiAobW9kLnBhcmVudCkge1xuICAgIHJldHVybiBpblJlcG8obW9kLnBhcmVudClcbiAgfVxuICByZXR1cm4gZmFsc2Vcbn1cblxuLy8gVGhlIGZvbGxvd2luZyBlbnN1cmVzIHRoYXQgdGhlcmUgaXMgYWx3YXlzIG9ubHkgYSBzaW5nbGUgKGFuZCBzYW1lKVxuLy8gY29weSBvZiBSZWFjdCBpbiBhbiBhcHAgYXQgYW55IGdpdmVuIG1vbWVudC5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuTW9kdWxlLnByb3RvdHlwZS5yZXF1aXJlID0gZnVuY3Rpb24obW9kdWxlUGF0aCkge1xuICAvLyBJZiB3ZSBhcmUgcnVubmluZyBpbiB0aGUgcmVwbywgd2UgbmVlZCB0byBtYWtlIHN1cmVcbiAgLy8gbW9kdWxlIHJlc29sdXRpb25zIGNvbWluZyBmcm9tIG90aGVyIHJlYWN0LXN0YXRpYyBwYWNrYWdlc1xuICAvLyBhcmUgZmlyc3QgYXR0ZW1wdGVkIGZyb20gdGhlXG4gIGNvbnN0IGlzSW5Xb3Jrc3BhY2UgPSBuZWVkc1dvcmtzcGFjZUNoZWNrICYmIGluUmVwbyh0aGlzKVxuXG4gIC8vIE9ubHkgcmVkaXJlY3QgcmVzb2x1dGlvbnMgdG8gbm9uLXJlbGF0aXZlIGFuZCBub24tYWJzb2x1dGUgbW9kdWxlc1xuICBpZiAoIW1vZHVsZVBhdGguc3RhcnRzV2l0aCgnLicpICYmICFtb2R1bGVQYXRoLnN0YXJ0c1dpdGgoJy8nKSkge1xuICAgIGlmIChcbiAgICAgIC8vIElmIG1vZHVsZSBpcyBpbiB0aGUgcmVwbyB0cnkgYW5kIHJlZGlyZWN0XG4gICAgICBpc0luV29ya3NwYWNlIHx8XG4gICAgICAvLyBBbHdheXMgdHJ5IGFuZCByZWRpcmVjdCByZWFjdCBhbmQgcmVhY3QtZG9tIHJlc29sdXRpb25zXG4gICAgICBbJ3JlYWN0JywgJ3JlYWN0LWRvbSddLnNvbWUoZCA9PiBtb2R1bGVQYXRoLmluY2x1ZGVzKGQpKVxuICAgICkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgbW9kdWxlUGF0aCA9IHJlc29sdmVGcm9tKFxuICAgICAgICAgIHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnbm9kZV9tb2R1bGVzJyksXG4gICAgICAgICAgbW9kdWxlUGF0aFxuICAgICAgICApXG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy9cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIG9yaWdpbmFsUmVxdWlyZS5jYWxsKHRoaXMsIG1vZHVsZVBhdGgpXG59XG5cbnJlcXVpcmUoJ0BiYWJlbC9yZWdpc3RlcicpKHtcbiAgYmFiZWxyYzogZmFsc2UsXG4gIHByZXNldHM6IFtcbiAgICBbXG4gICAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4vYmFiZWwtcHJlc2V0LmpzJyksXG4gICAgICB7XG4gICAgICAgIG5vZGU6IHRydWUsXG4gICAgICB9LFxuICAgIF0sXG4gIF0sXG4gIGlnbm9yZTogW1xuICAgIGZ1bmN0aW9uIGJhYmVsSWdub3JlKGZpbGVuYW1lKSB7XG4gICAgICAvLyB0cnVlIGlmIHNob3VsZCBpZ25vcmVcbiAgICAgIHJldHVybiAoXG4gICAgICAgIG5ldyBSZWdFeHAoZXNjYXBlUmVnRXhwKGAke3BhdGguc2VwfW5vZGVfbW9kdWxlcyR7cGF0aC5zZXB9YCkpLnRlc3QoXG4gICAgICAgICAgZmlsZW5hbWVcbiAgICAgICAgKSB8fFxuICAgICAgICAoaWdub3JlUGF0aCAmJiBpZ25vcmVQYXRoLnRlc3QoZmlsZW5hbWUpKVxuICAgICAgKVxuICAgIH0sXG4gIF0sXG59KVxuXG4vLyBuZWNlc2FycnkgYXQgYW55IGVudHJ5IHBvaW50IG9mIHRoZSBjbGkgdG8gZW5zdXJlIHRoYXQgQmFiZWwtcmVnaXN0ZXJcbi8vIGRvZXMgbm90IGF0dGVtcHQgdG8gdHJhbnNmb3JtIG5vbiBKYXZhU2NyaXB0IGZpbGVzLlxuY29uc3QgaWdub3JlZEV4dGVuc2lvbnMgPSBbXG4gICdjc3MnLFxuICAnc2NzcycsXG4gICdzdHlsJyxcbiAgJ2xlc3MnLFxuICAncG5nJyxcbiAgJ2dpZicsXG4gICdqcGcnLFxuICAnanBlZycsXG4gICdzdmcnLFxuICAnd29mZicsXG4gICd3b2ZmMicsXG4gICd0dGYnLFxuICAnZW90JyxcbiAgJ290ZicsXG4gICdtcDQnLFxuICAnd2VibScsXG4gICdvZ2cnLFxuICAnbXAzJyxcbiAgJ3dhdicsXG4gICdtZCcsXG4gICd5YW1sJyxcbl1cbmlnbm9yZWRFeHRlbnNpb25zLmZvckVhY2goZXh0ID0+IHtcbiAgcmVxdWlyZS5leHRlbnNpb25zW2AuJHtleHR9YF0gPSAoKSA9PiB7fVxufSlcblxuY29uc29sZS5lcnJvciA9IChlcnIsIC4uLnJlc3QpID0+IHtcbiAgY29uc29sZS5sb2cobmV3IFByZXR0eUVycm9yKCkucmVuZGVyKGVyciksIC4uLnJlc3QpXG59XG5cbi8vIEJlIHN1cmUgdG8gbG9nIHVzZWZ1bCBpbmZvcm1hdGlvbiBhYm91dCB1bmhhbmRsZWQgZXhjZXB0aW9ucy4gVGhpcyBzaG91bGQgc2VyaW91c2x5XG4vLyBiZSBhIGRlZmF1bHQ6IGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS9pc3N1ZXMvOTUyMyNpc3N1ZWNvbW1lbnQtMjU5MzAzMDc5XG5wcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCByID0+IHtcbiAgY29uc29sZS5lcnJvcihyKVxufSlcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHNldElnbm9yZVBhdGgocGF0aCkge1xuICAgIGlnbm9yZVBhdGggPSBwYXRoID8gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeHAocGF0aCkpIDogdW5kZWZpbmVkXG4gIH0sXG59XG4iXX0=