"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _react = _interopRequireDefault(require("react"));

var _server = require("react-dom/server");

var _reactHelmet = _interopRequireDefault(require("react-helmet"));

var _reactUniversalComponent = require("react-universal-component");

var _webpackFlushChunks = _interopRequireDefault(require("webpack-flush-chunks"));

var _path = _interopRequireDefault(require("path"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _Redirect = _interopRequireDefault(require("./components/Redirect"));

var _plugins = _interopRequireDefault(require("./plugins"));

var _utils = require("../utils");

var _chunkBuilder = require("../utils/chunkBuilder");

var _HtmlWithMeta = require("./components/HtmlWithMeta");

var _HeadWithMeta = require("./components/HeadWithMeta");

var _BodyWithMeta = require("./components/BodyWithMeta");

//
var cachedBasePath;
var cachedHrefReplace;
var cachedSrcReplace;

var _default =
/*#__PURE__*/
function () {
  var _exportRoute = (0, _asyncToGenerator2.default)(
  /*#__PURE__*/
  _regenerator.default.mark(function _callee(state) {
    var _state, config, DocumentTemplate, route, siteData, clientStats, incremental, _state2, Comp, sharedHashesByProp, template, data, sharedData, routePath, remove, removeLocation, basePath, hrefReplace, srcReplace, routeInfo, embeddedRouteInfo, meta, chunkNames, head, clientScripts, clientStyleSheets, clientCss, FinalComp, renderToStringAndExtract, appHtml, RenderedComp, DocumentHtml, html, publicPath, htmlFilename, routeInfoFilename, res;

    return _regenerator.default.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            _state = state, config = _state.config, DocumentTemplate = _state.DocumentTemplate, route = _state.route, siteData = _state.siteData, clientStats = _state.clientStats, incremental = _state.incremental;
            _state2 = state, Comp = _state2.Comp;
            sharedHashesByProp = route.sharedHashesByProp, template = route.template, data = route.data, sharedData = route.sharedData, routePath = route.path, remove = route.remove;

            if (!(incremental && remove)) {
              _context.next = 8;
              break;
            }

            if (!(route.path === '404' || route.path === '/')) {
              _context.next = 6;
              break;
            }

            throw new Error("You are attempting to incrementally remove the ".concat(route.path === '404' ? '404' : 'index', " route from your export. This is currently not supported (or recommended) by React Static."));

          case 6:
            removeLocation = _path.default.join(config.paths.DIST, route.path);
            return _context.abrupt("return", _fsExtra.default.remove(removeLocation));

          case 8:
            basePath = cachedBasePath || (cachedBasePath = config.basePath);
            hrefReplace = cachedHrefReplace || (cachedHrefReplace = new RegExp("(href=[\"'])\\/(".concat(basePath ? "".concat(basePath, "\\/") : '', ")?([^\\/])"), 'gm'));
            srcReplace = cachedSrcReplace || (cachedSrcReplace = new RegExp("(src=[\"'])\\/(".concat(basePath ? "".concat(basePath, "\\/") : '', ")?([^\\/])"), 'gm')); // This routeInfo will be saved to disk. It should only include the
            // data and hashes to construct all of the props later.

            routeInfo = {
              template: template,
              sharedHashesByProp: sharedHashesByProp,
              data: data,
              path: routePath // This embeddedRouteInfo will be inlined into the HTML for this route.
              // It should include all of the data, including shared data

            };
            embeddedRouteInfo = (0, _objectSpread2.default)({}, routeInfo, {
              sharedData: sharedData,
              siteData: siteData
            });
            state = (0, _objectSpread2.default)({}, state, {
              routeInfo: routeInfo,
              embeddedRouteInfo: embeddedRouteInfo // Make a place to collect chunks, meta info and head tags

            });
            meta = {};
            chunkNames = [];
            head = {};
            clientScripts = [];
            clientStyleSheets = [];
            clientCss = {};
            // Get the react component from the Comp and
            // pass it the export context. This uses
            // reactContext under the hood to pass down
            // the exportContext, since react's new context
            // api doesn't survive across bundling.
            Comp = config.disableRuntime ? Comp : Comp(embeddedRouteInfo);

            if (route.redirect) {
              FinalComp = function FinalComp() {
                return _react.default.createElement(_Redirect.default, {
                  fromPath: route.path,
                  to: route.redirect
                });
              };
            } else {
              FinalComp = function FinalComp(props) {
                return _react.default.createElement(_reactUniversalComponent.ReportChunks, {
                  report: function report(chunkName) {
                    // if we are building to a absolute path we must make the detected chunkName relative and matching to the one we set in generateTemplates
                    if (!config.paths.DIST.startsWith(config.paths.ROOT)) {
                      chunkName = (0, _chunkBuilder.absoluteToRelativeChunkName)(config.paths.ROOT, chunkName);
                    }

                    chunkNames.push(chunkName);
                  }
                }, _react.default.createElement(Comp, props));
              };
            }

            renderToStringAndExtract = function renderToStringAndExtract(comp) {
              // Rend the app to string!
              var appHtml = (0, _server.renderToString)(comp);

              var _flushChunks = (0, _webpackFlushChunks.default)(clientStats, {
                chunkNames: chunkNames,
                outputPath: config.paths.DIST
              }),
                  scripts = _flushChunks.scripts,
                  stylesheets = _flushChunks.stylesheets,
                  css = _flushChunks.css;

              clientScripts = scripts;
              clientStyleSheets = stylesheets;
              clientCss = css; // Extract head calls using Helmet synchronously right after renderToString
              // to not introduce any race conditions in the meta data rendering

              var helmet = _reactHelmet.default.renderStatic();

              head = {
                htmlProps: helmet.htmlAttributes.toComponent(),
                bodyProps: helmet.bodyAttributes.toComponent(),
                base: helmet.base.toComponent(),
                link: helmet.link.toComponent(),
                meta: helmet.meta.toComponent(),
                noscript: helmet.noscript.toComponent(),
                script: helmet.script.toComponent(),
                style: helmet.style.toComponent(),
                title: helmet.title.toComponent()
              };
              return appHtml;
            };

            state = (0, _objectSpread2.default)({}, state, {
              meta: meta
            });
            _context.prev = 24;
            _context.next = 27;
            return _plugins.default.beforeRenderToElement(FinalComp, state);

          case 27:
            FinalComp = _context.sent;

            if (!config.renderToElement) {
              _context.next = 30;
              break;
            }

            throw new Error("config.renderToElement has been deprecated in favor of the 'beforeRenderToElement' or 'beforeRenderToHtml' hooks instead.");

          case 30:
            RenderedComp = _react.default.createElement(FinalComp, null); // Run the beforeRenderToHtml hook
            // Rum the Html hook

            _context.next = 33;
            return _plugins.default.beforeRenderToHtml(RenderedComp, state);

          case 33:
            RenderedComp = _context.sent;

            if (!config.renderToHtml) {
              _context.next = 36;
              break;
            }

            throw new Error("config.renderToHtml has been deprecated in favor of the 'beforeRenderToHtml' or 'beforeHtmlToDocument' hooks instead.");

          case 36:
            appHtml = renderToStringAndExtract(RenderedComp);
            _context.next = 39;
            return _plugins.default.beforeHtmlToDocument(appHtml, state);

          case 39:
            appHtml = _context.sent;
            _context.next = 47;
            break;

          case 42:
            _context.prev = 42;
            _context.t0 = _context["catch"](24);

            if (_context.t0.then) {
              _context.t0.message = 'Components are not allowed to suspend during static export. Please make its data available synchronously and try again!';
            }

            _context.t0.message = "Failed exporting HTML for URL ".concat(route.path, " (").concat(route.template, "): ").concat(_context.t0.message);
            throw _context.t0;

          case 47:
            state = (0, _objectSpread2.default)({}, state, {
              head: head,
              clientScripts: clientScripts,
              clientStyleSheets: clientStyleSheets,
              clientCss: clientCss
            });
            _context.t1 = _server.renderToStaticMarkup;
            _context.t2 = _react.default;
            _context.t3 = DocumentTemplate;
            _context.next = 53;
            return (0, _HtmlWithMeta.makeHtmlWithMeta)(state);

          case 53:
            _context.t4 = _context.sent;
            _context.next = 56;
            return (0, _HeadWithMeta.makeHeadWithMeta)(state);

          case 56:
            _context.t5 = _context.sent;
            _context.next = 59;
            return (0, _BodyWithMeta.makeBodyWithMeta)(state);

          case 59:
            _context.t6 = _context.sent;
            _context.t7 = state;
            _context.t8 = {
              Html: _context.t4,
              Head: _context.t5,
              Body: _context.t6,
              state: _context.t7
            };
            _context.t9 = _react.default.createElement("div", {
              id: "root",
              dangerouslySetInnerHTML: {
                __html: appHtml
              }
            });
            _context.t10 = _context.t2.createElement.call(_context.t2, _context.t3, _context.t8, _context.t9);
            DocumentHtml = (0, _context.t1)(_context.t10);
            // Render the html for the page inside of the base document.
            html = "<!DOCTYPE html>".concat(DocumentHtml);
            _context.next = 68;
            return _plugins.default.beforeDocumentToFile(html, state);

          case 68:
            html = _context.sent;
            // If the siteRoot is set and we're not in staging, prefix all absolute URLs
            // with the siteRoot
            publicPath = (0, _utils.makePathAbsolute)(process.env.REACT_STATIC_PUBLIC_PATH);

            if (process.env.REACT_STATIC_DISABLE_ROUTE_PREFIXING !== 'true') {
              html = html.replace(hrefReplace, "$1".concat(publicPath, "$3"));
            }

            html = html.replace(srcReplace, "$1".concat(publicPath, "$3")); // If the route is a 404 page, write it directly to 404.html, instead of
            // inside a directory.

            htmlFilename = route.path === '404' ? _path.default.join(config.paths.DIST, '404.html') : _path.default.join(config.paths.DIST, route.path, 'index.html'); // Make the routeInfo sit right next to its companion html file

            routeInfoFilename = _path.default.join(config.paths.DIST, route.path, 'routeInfo.json');
            _context.next = 76;
            return Promise.all([_fsExtra.default.outputFile(htmlFilename, html), !route.redirect ? _fsExtra.default.outputJson(routeInfoFilename, routeInfo) : Promise.resolve()]);

          case 76:
            res = _context.sent;
            return _context.abrupt("return", res);

          case 78:
          case "end":
            return _context.stop();
        }
      }
    }, _callee, null, [[24, 42]]);
  }));

  function exportRoute(_x) {
    return _exportRoute.apply(this, arguments);
  }

  return exportRoute;
}();

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdGF0aWMvZXhwb3J0Um91dGUuanMiXSwibmFtZXMiOlsiY2FjaGVkQmFzZVBhdGgiLCJjYWNoZWRIcmVmUmVwbGFjZSIsImNhY2hlZFNyY1JlcGxhY2UiLCJzdGF0ZSIsImNvbmZpZyIsIkRvY3VtZW50VGVtcGxhdGUiLCJyb3V0ZSIsInNpdGVEYXRhIiwiY2xpZW50U3RhdHMiLCJpbmNyZW1lbnRhbCIsIkNvbXAiLCJzaGFyZWRIYXNoZXNCeVByb3AiLCJ0ZW1wbGF0ZSIsImRhdGEiLCJzaGFyZWREYXRhIiwicm91dGVQYXRoIiwicGF0aCIsInJlbW92ZSIsIkVycm9yIiwicmVtb3ZlTG9jYXRpb24iLCJub2RlUGF0aCIsImpvaW4iLCJwYXRocyIsIkRJU1QiLCJmcyIsImJhc2VQYXRoIiwiaHJlZlJlcGxhY2UiLCJSZWdFeHAiLCJzcmNSZXBsYWNlIiwicm91dGVJbmZvIiwiZW1iZWRkZWRSb3V0ZUluZm8iLCJtZXRhIiwiY2h1bmtOYW1lcyIsImhlYWQiLCJjbGllbnRTY3JpcHRzIiwiY2xpZW50U3R5bGVTaGVldHMiLCJjbGllbnRDc3MiLCJkaXNhYmxlUnVudGltZSIsInJlZGlyZWN0IiwiRmluYWxDb21wIiwicHJvcHMiLCJjaHVua05hbWUiLCJzdGFydHNXaXRoIiwiUk9PVCIsInB1c2giLCJyZW5kZXJUb1N0cmluZ0FuZEV4dHJhY3QiLCJjb21wIiwiYXBwSHRtbCIsIm91dHB1dFBhdGgiLCJzY3JpcHRzIiwic3R5bGVzaGVldHMiLCJjc3MiLCJoZWxtZXQiLCJIZWxtZXQiLCJyZW5kZXJTdGF0aWMiLCJodG1sUHJvcHMiLCJodG1sQXR0cmlidXRlcyIsInRvQ29tcG9uZW50IiwiYm9keVByb3BzIiwiYm9keUF0dHJpYnV0ZXMiLCJiYXNlIiwibGluayIsIm5vc2NyaXB0Iiwic2NyaXB0Iiwic3R5bGUiLCJ0aXRsZSIsInBsdWdpbnMiLCJiZWZvcmVSZW5kZXJUb0VsZW1lbnQiLCJyZW5kZXJUb0VsZW1lbnQiLCJSZW5kZXJlZENvbXAiLCJiZWZvcmVSZW5kZXJUb0h0bWwiLCJyZW5kZXJUb0h0bWwiLCJiZWZvcmVIdG1sVG9Eb2N1bWVudCIsInRoZW4iLCJtZXNzYWdlIiwicmVuZGVyVG9TdGF0aWNNYXJrdXAiLCJfX2h0bWwiLCJEb2N1bWVudEh0bWwiLCJodG1sIiwiYmVmb3JlRG9jdW1lbnRUb0ZpbGUiLCJwdWJsaWNQYXRoIiwicHJvY2VzcyIsImVudiIsIlJFQUNUX1NUQVRJQ19QVUJMSUNfUEFUSCIsIlJFQUNUX1NUQVRJQ19ESVNBQkxFX1JPVVRFX1BSRUZJWElORyIsInJlcGxhY2UiLCJodG1sRmlsZW5hbWUiLCJyb3V0ZUluZm9GaWxlbmFtZSIsIlByb21pc2UiLCJhbGwiLCJvdXRwdXRGaWxlIiwib3V0cHV0SnNvbiIsInJlc29sdmUiLCJyZXMiLCJleHBvcnRSb3V0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7QUFFQSxJQUFJQSxjQUFKO0FBQ0EsSUFBSUMsaUJBQUo7QUFDQSxJQUFJQyxnQkFBSjs7Ozs7Ozs0QkFFZ0IsaUJBQTJCQyxLQUEzQjtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEscUJBUVZBLEtBUlUsRUFFWkMsTUFGWSxVQUVaQSxNQUZZLEVBR1pDLGdCQUhZLFVBR1pBLGdCQUhZLEVBSVpDLEtBSlksVUFJWkEsS0FKWSxFQUtaQyxRQUxZLFVBS1pBLFFBTFksRUFNWkMsV0FOWSxVQU1aQSxXQU5ZLEVBT1pDLFdBUFksVUFPWkEsV0FQWTtBQUFBLHNCQVVDTixLQVZELEVBVVJPLElBVlEsV0FVUkEsSUFWUTtBQWFaQyxZQUFBQSxrQkFiWSxHQW1CVkwsS0FuQlUsQ0FhWkssa0JBYlksRUFjWkMsUUFkWSxHQW1CVk4sS0FuQlUsQ0FjWk0sUUFkWSxFQWVaQyxJQWZZLEdBbUJWUCxLQW5CVSxDQWVaTyxJQWZZLEVBZ0JaQyxVQWhCWSxHQW1CVlIsS0FuQlUsQ0FnQlpRLFVBaEJZLEVBaUJOQyxTQWpCTSxHQW1CVlQsS0FuQlUsQ0FpQlpVLElBakJZLEVBa0JaQyxNQWxCWSxHQW1CVlgsS0FuQlUsQ0FrQlpXLE1BbEJZOztBQUFBLGtCQXFCVlIsV0FBVyxJQUFJUSxNQXJCTDtBQUFBO0FBQUE7QUFBQTs7QUFBQSxrQkFzQlJYLEtBQUssQ0FBQ1UsSUFBTixLQUFlLEtBQWYsSUFBd0JWLEtBQUssQ0FBQ1UsSUFBTixLQUFlLEdBdEIvQjtBQUFBO0FBQUE7QUFBQTs7QUFBQSxrQkF1QkosSUFBSUUsS0FBSiwwREFFRlosS0FBSyxDQUFDVSxJQUFOLEtBQWUsS0FBZixHQUF1QixLQUF2QixHQUErQixPQUY3QixnR0F2Qkk7O0FBQUE7QUE2Qk5HLFlBQUFBLGNBN0JNLEdBNkJXQyxjQUFTQyxJQUFULENBQWNqQixNQUFNLENBQUNrQixLQUFQLENBQWFDLElBQTNCLEVBQWlDakIsS0FBSyxDQUFDVSxJQUF2QyxDQTdCWDtBQUFBLDZDQThCTFEsaUJBQUdQLE1BQUgsQ0FBVUUsY0FBVixDQTlCSzs7QUFBQTtBQWlDUk0sWUFBQUEsUUFqQ1EsR0FpQ0d6QixjQUFjLEtBQUtBLGNBQWMsR0FBR0ksTUFBTSxDQUFDcUIsUUFBN0IsQ0FqQ2pCO0FBbUNSQyxZQUFBQSxXQW5DUSxHQW9DWnpCLGlCQUFpQixLQUNoQkEsaUJBQWlCLEdBQUcsSUFBSTBCLE1BQUosMkJBQ0RGLFFBQVEsYUFBTUEsUUFBTixXQUFzQixFQUQ3QixpQkFFbkIsSUFGbUIsQ0FESixDQXBDTDtBQTBDUkcsWUFBQUEsVUExQ1EsR0EyQ1oxQixnQkFBZ0IsS0FDZkEsZ0JBQWdCLEdBQUcsSUFBSXlCLE1BQUosMEJBQ0RGLFFBQVEsYUFBTUEsUUFBTixXQUFzQixFQUQ3QixpQkFFbEIsSUFGa0IsQ0FESixDQTNDSixFQWlEZDtBQUNBOztBQUNNSSxZQUFBQSxTQW5EUSxHQW1ESTtBQUNoQmpCLGNBQUFBLFFBQVEsRUFBUkEsUUFEZ0I7QUFFaEJELGNBQUFBLGtCQUFrQixFQUFsQkEsa0JBRmdCO0FBR2hCRSxjQUFBQSxJQUFJLEVBQUpBLElBSGdCO0FBSWhCRyxjQUFBQSxJQUFJLEVBQUVELFNBSlUsQ0FPbEI7QUFDQTs7QUFSa0IsYUFuREo7QUE0RFJlLFlBQUFBLGlCQTVEUSxtQ0E2RFRELFNBN0RTO0FBOERaZixjQUFBQSxVQUFVLEVBQVZBLFVBOURZO0FBK0RaUCxjQUFBQSxRQUFRLEVBQVJBO0FBL0RZO0FBa0VkSixZQUFBQSxLQUFLLG1DQUNBQSxLQURBO0FBRUgwQixjQUFBQSxTQUFTLEVBQVRBLFNBRkc7QUFHSEMsY0FBQUEsaUJBQWlCLEVBQWpCQSxpQkFIRyxDQU1MOztBQU5LLGNBQUw7QUFPTUMsWUFBQUEsSUF6RVEsR0F5RUQsRUF6RUM7QUEwRVJDLFlBQUFBLFVBMUVRLEdBMEVLLEVBMUVMO0FBMkVWQyxZQUFBQSxJQTNFVSxHQTJFSCxFQTNFRztBQTRFVkMsWUFBQUEsYUE1RVUsR0E0RU0sRUE1RU47QUE2RVZDLFlBQUFBLGlCQTdFVSxHQTZFVSxFQTdFVjtBQThFVkMsWUFBQUEsU0E5RVUsR0E4RUUsRUE5RUY7QUFrRmQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBMUIsWUFBQUEsSUFBSSxHQUFHTixNQUFNLENBQUNpQyxjQUFQLEdBQXdCM0IsSUFBeEIsR0FBK0JBLElBQUksQ0FBQ29CLGlCQUFELENBQTFDOztBQUVBLGdCQUFJeEIsS0FBSyxDQUFDZ0MsUUFBVixFQUFvQjtBQUNsQkMsY0FBQUEsU0FBUyxHQUFHO0FBQUEsdUJBQU0sNkJBQUMsaUJBQUQ7QUFBVSxrQkFBQSxRQUFRLEVBQUVqQyxLQUFLLENBQUNVLElBQTFCO0FBQWdDLGtCQUFBLEVBQUUsRUFBRVYsS0FBSyxDQUFDZ0M7QUFBMUMsa0JBQU47QUFBQSxlQUFaO0FBQ0QsYUFGRCxNQUVPO0FBQ0xDLGNBQUFBLFNBQVMsR0FBRyxtQkFBQUMsS0FBSztBQUFBLHVCQUNmLDZCQUFDLHFDQUFEO0FBQ0Usa0JBQUEsTUFBTSxFQUFFLGdCQUFBQyxTQUFTLEVBQUk7QUFDbkI7QUFDQSx3QkFBSSxDQUFDckMsTUFBTSxDQUFDa0IsS0FBUCxDQUFhQyxJQUFiLENBQWtCbUIsVUFBbEIsQ0FBNkJ0QyxNQUFNLENBQUNrQixLQUFQLENBQWFxQixJQUExQyxDQUFMLEVBQXNEO0FBQ3BERixzQkFBQUEsU0FBUyxHQUFHLCtDQUNWckMsTUFBTSxDQUFDa0IsS0FBUCxDQUFhcUIsSUFESCxFQUVWRixTQUZVLENBQVo7QUFJRDs7QUFFRFQsb0JBQUFBLFVBQVUsQ0FBQ1ksSUFBWCxDQUFnQkgsU0FBaEI7QUFDRDtBQVhILG1CQWFFLDZCQUFDLElBQUQsRUFBVUQsS0FBVixDQWJGLENBRGU7QUFBQSxlQUFqQjtBQWlCRDs7QUFFS0ssWUFBQUEsd0JBL0dRLEdBK0dtQixTQUEzQkEsd0JBQTJCLENBQUFDLElBQUksRUFBSTtBQUN2QztBQUNBLGtCQUFNQyxPQUFPLEdBQUcsNEJBQWVELElBQWYsQ0FBaEI7O0FBRnVDLGlDQUdELGlDQUFZdEMsV0FBWixFQUF5QjtBQUM3RHdCLGdCQUFBQSxVQUFVLEVBQVZBLFVBRDZEO0FBRTdEZ0IsZ0JBQUFBLFVBQVUsRUFBRTVDLE1BQU0sQ0FBQ2tCLEtBQVAsQ0FBYUM7QUFGb0MsZUFBekIsQ0FIQztBQUFBLGtCQUcvQjBCLE9BSCtCLGdCQUcvQkEsT0FIK0I7QUFBQSxrQkFHdEJDLFdBSHNCLGdCQUd0QkEsV0FIc0I7QUFBQSxrQkFHVEMsR0FIUyxnQkFHVEEsR0FIUzs7QUFRdkNqQixjQUFBQSxhQUFhLEdBQUdlLE9BQWhCO0FBQ0FkLGNBQUFBLGlCQUFpQixHQUFHZSxXQUFwQjtBQUNBZCxjQUFBQSxTQUFTLEdBQUdlLEdBQVosQ0FWdUMsQ0FXdkM7QUFDQTs7QUFDQSxrQkFBTUMsTUFBTSxHQUFHQyxxQkFBT0MsWUFBUCxFQUFmOztBQUNBckIsY0FBQUEsSUFBSSxHQUFHO0FBQ0xzQixnQkFBQUEsU0FBUyxFQUFFSCxNQUFNLENBQUNJLGNBQVAsQ0FBc0JDLFdBQXRCLEVBRE47QUFFTEMsZ0JBQUFBLFNBQVMsRUFBRU4sTUFBTSxDQUFDTyxjQUFQLENBQXNCRixXQUF0QixFQUZOO0FBR0xHLGdCQUFBQSxJQUFJLEVBQUVSLE1BQU0sQ0FBQ1EsSUFBUCxDQUFZSCxXQUFaLEVBSEQ7QUFJTEksZ0JBQUFBLElBQUksRUFBRVQsTUFBTSxDQUFDUyxJQUFQLENBQVlKLFdBQVosRUFKRDtBQUtMMUIsZ0JBQUFBLElBQUksRUFBRXFCLE1BQU0sQ0FBQ3JCLElBQVAsQ0FBWTBCLFdBQVosRUFMRDtBQU1MSyxnQkFBQUEsUUFBUSxFQUFFVixNQUFNLENBQUNVLFFBQVAsQ0FBZ0JMLFdBQWhCLEVBTkw7QUFPTE0sZ0JBQUFBLE1BQU0sRUFBRVgsTUFBTSxDQUFDVyxNQUFQLENBQWNOLFdBQWQsRUFQSDtBQVFMTyxnQkFBQUEsS0FBSyxFQUFFWixNQUFNLENBQUNZLEtBQVAsQ0FBYVAsV0FBYixFQVJGO0FBU0xRLGdCQUFBQSxLQUFLLEVBQUViLE1BQU0sQ0FBQ2EsS0FBUCxDQUFhUixXQUFiO0FBVEYsZUFBUDtBQVlBLHFCQUFPVixPQUFQO0FBQ0QsYUExSWE7O0FBOElkNUMsWUFBQUEsS0FBSyxtQ0FDQUEsS0FEQTtBQUVINEIsY0FBQUEsSUFBSSxFQUFKQTtBQUZHLGNBQUw7QUE5SWM7QUFBQTtBQUFBLG1CQW9KTW1DLGlCQUFRQyxxQkFBUixDQUE4QjVCLFNBQTlCLEVBQXlDcEMsS0FBekMsQ0FwSk47O0FBQUE7QUFvSlpvQyxZQUFBQSxTQXBKWTs7QUFBQSxpQkFzSlJuQyxNQUFNLENBQUNnRSxlQXRKQztBQUFBO0FBQUE7QUFBQTs7QUFBQSxrQkF1SkosSUFBSWxELEtBQUosNkhBdkpJOztBQUFBO0FBNEpSbUQsWUFBQUEsWUE1SlEsR0E0Sk8sNkJBQUMsU0FBRCxPQTVKUCxFQThKWjtBQUNBOztBQS9KWTtBQUFBLG1CQWdLU0gsaUJBQVFJLGtCQUFSLENBQTJCRCxZQUEzQixFQUF5Q2xFLEtBQXpDLENBaEtUOztBQUFBO0FBZ0taa0UsWUFBQUEsWUFoS1k7O0FBQUEsaUJBa0tSakUsTUFBTSxDQUFDbUUsWUFsS0M7QUFBQTtBQUFBO0FBQUE7O0FBQUEsa0JBbUtKLElBQUlyRCxLQUFKLHlIQW5LSTs7QUFBQTtBQXdLWjZCLFlBQUFBLE9BQU8sR0FBR0Ysd0JBQXdCLENBQUN3QixZQUFELENBQWxDO0FBeEtZO0FBQUEsbUJBMEtJSCxpQkFBUU0sb0JBQVIsQ0FBNkJ6QixPQUE3QixFQUFzQzVDLEtBQXRDLENBMUtKOztBQUFBO0FBMEtaNEMsWUFBQUEsT0ExS1k7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQTs7QUE0S1osZ0JBQUksWUFBTTBCLElBQVYsRUFBZ0I7QUFDZCwwQkFBTUMsT0FBTixHQUNFLHlIQURGO0FBRUQ7O0FBQ0Qsd0JBQU1BLE9BQU4sMkNBQWlEcEUsS0FBSyxDQUFDVSxJQUF2RCxlQUNFVixLQUFLLENBQUNNLFFBRFIsZ0JBRU0sWUFBTThELE9BRlo7QUFoTFk7O0FBQUE7QUFzTGR2RSxZQUFBQSxLQUFLLG1DQUNBQSxLQURBO0FBRUg4QixjQUFBQSxJQUFJLEVBQUpBLElBRkc7QUFHSEMsY0FBQUEsYUFBYSxFQUFiQSxhQUhHO0FBSUhDLGNBQUFBLGlCQUFpQixFQUFqQkEsaUJBSkc7QUFLSEMsY0FBQUEsU0FBUyxFQUFUQTtBQUxHLGNBQUw7QUF0TGMsMEJBOExPdUMsNEJBOUxQO0FBQUE7QUFBQSwwQkErTFgsZ0JBL0xXO0FBQUE7QUFBQSxtQkFnTUUsb0NBQWlCeEUsS0FBakIsQ0FoTUY7O0FBQUE7QUFBQTtBQUFBO0FBQUEsbUJBaU1FLG9DQUFpQkEsS0FBakIsQ0FqTUY7O0FBQUE7QUFBQTtBQUFBO0FBQUEsbUJBa01FLG9DQUFpQkEsS0FBakIsQ0FsTUY7O0FBQUE7QUFBQTtBQUFBLDBCQW1NSEEsS0FuTUc7QUFBQTtBQWdNVixjQUFBLElBaE1VO0FBaU1WLGNBQUEsSUFqTVU7QUFrTVYsY0FBQSxJQWxNVTtBQW1NVixjQUFBLEtBbk1VO0FBQUE7QUFBQSwwQkFxTVY7QUFBSyxjQUFBLEVBQUUsRUFBQyxNQUFSO0FBQWUsY0FBQSx1QkFBdUIsRUFBRTtBQUFFeUUsZ0JBQUFBLE1BQU0sRUFBRTdCO0FBQVY7QUFBeEMsY0FyTVU7QUFBQTtBQThMUjhCLFlBQUFBLFlBOUxRO0FBeU1kO0FBQ0lDLFlBQUFBLElBMU1VLDRCQTBNZUQsWUExTWY7QUFBQTtBQUFBLG1CQTRNRFgsaUJBQVFhLG9CQUFSLENBQTZCRCxJQUE3QixFQUFtQzNFLEtBQW5DLENBNU1DOztBQUFBO0FBNE1kMkUsWUFBQUEsSUE1TWM7QUE4TWQ7QUFDQTtBQUNNRSxZQUFBQSxVQWhOUSxHQWdOSyw2QkFBaUJDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyx3QkFBN0IsQ0FoTkw7O0FBaU5kLGdCQUFJRixPQUFPLENBQUNDLEdBQVIsQ0FBWUUsb0NBQVosS0FBcUQsTUFBekQsRUFBaUU7QUFDL0ROLGNBQUFBLElBQUksR0FBR0EsSUFBSSxDQUFDTyxPQUFMLENBQWEzRCxXQUFiLGNBQStCc0QsVUFBL0IsUUFBUDtBQUNEOztBQUVERixZQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQ08sT0FBTCxDQUFhekQsVUFBYixjQUE4Qm9ELFVBQTlCLFFBQVAsQ0FyTmMsQ0F1TmQ7QUFDQTs7QUFDTU0sWUFBQUEsWUF6TlEsR0EwTlpoRixLQUFLLENBQUNVLElBQU4sS0FBZSxLQUFmLEdBQ0lJLGNBQVNDLElBQVQsQ0FBY2pCLE1BQU0sQ0FBQ2tCLEtBQVAsQ0FBYUMsSUFBM0IsRUFBaUMsVUFBakMsQ0FESixHQUVJSCxjQUFTQyxJQUFULENBQWNqQixNQUFNLENBQUNrQixLQUFQLENBQWFDLElBQTNCLEVBQWlDakIsS0FBSyxDQUFDVSxJQUF2QyxFQUE2QyxZQUE3QyxDQTVOUSxFQThOZDs7QUFDTXVFLFlBQUFBLGlCQS9OUSxHQStOWW5FLGNBQVNDLElBQVQsQ0FDeEJqQixNQUFNLENBQUNrQixLQUFQLENBQWFDLElBRFcsRUFFeEJqQixLQUFLLENBQUNVLElBRmtCLEVBR3hCLGdCQUh3QixDQS9OWjtBQUFBO0FBQUEsbUJBcU9Jd0UsT0FBTyxDQUFDQyxHQUFSLENBQVksQ0FDNUJqRSxpQkFBR2tFLFVBQUgsQ0FBY0osWUFBZCxFQUE0QlIsSUFBNUIsQ0FENEIsRUFFNUIsQ0FBQ3hFLEtBQUssQ0FBQ2dDLFFBQVAsR0FDSWQsaUJBQUdtRSxVQUFILENBQWNKLGlCQUFkLEVBQWlDMUQsU0FBakMsQ0FESixHQUVJMkQsT0FBTyxDQUFDSSxPQUFSLEVBSndCLENBQVosQ0FyT0o7O0FBQUE7QUFxT1JDLFlBQUFBLEdBck9RO0FBQUEsNkNBMk9QQSxHQTNPTzs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxHOztXQUFlQyxXOzs7O1NBQUFBLFciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgeyByZW5kZXJUb1N0cmluZywgcmVuZGVyVG9TdGF0aWNNYXJrdXAgfSBmcm9tICdyZWFjdC1kb20vc2VydmVyJ1xuaW1wb3J0IEhlbG1ldCBmcm9tICdyZWFjdC1oZWxtZXQnXG5pbXBvcnQgeyBSZXBvcnRDaHVua3MgfSBmcm9tICdyZWFjdC11bml2ZXJzYWwtY29tcG9uZW50J1xuaW1wb3J0IGZsdXNoQ2h1bmtzIGZyb20gJ3dlYnBhY2stZmx1c2gtY2h1bmtzJ1xuaW1wb3J0IG5vZGVQYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnXG5cbmltcG9ydCBSZWRpcmVjdCBmcm9tICcuL2NvbXBvbmVudHMvUmVkaXJlY3QnXG5pbXBvcnQgcGx1Z2lucyBmcm9tICcuL3BsdWdpbnMnXG5pbXBvcnQgeyBtYWtlUGF0aEFic29sdXRlIH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQgeyBhYnNvbHV0ZVRvUmVsYXRpdmVDaHVua05hbWUgfSBmcm9tICcuLi91dGlscy9jaHVua0J1aWxkZXInXG5cbmltcG9ydCB7IG1ha2VIdG1sV2l0aE1ldGEgfSBmcm9tICcuL2NvbXBvbmVudHMvSHRtbFdpdGhNZXRhJ1xuaW1wb3J0IHsgbWFrZUhlYWRXaXRoTWV0YSB9IGZyb20gJy4vY29tcG9uZW50cy9IZWFkV2l0aE1ldGEnXG5pbXBvcnQgeyBtYWtlQm9keVdpdGhNZXRhIH0gZnJvbSAnLi9jb21wb25lbnRzL0JvZHlXaXRoTWV0YSdcblxuLy9cblxubGV0IGNhY2hlZEJhc2VQYXRoXG5sZXQgY2FjaGVkSHJlZlJlcGxhY2VcbmxldCBjYWNoZWRTcmNSZXBsYWNlXG5cbmV4cG9ydCBkZWZhdWx0IChhc3luYyBmdW5jdGlvbiBleHBvcnRSb3V0ZShzdGF0ZSkge1xuICBjb25zdCB7XG4gICAgY29uZmlnLFxuICAgIERvY3VtZW50VGVtcGxhdGUsXG4gICAgcm91dGUsXG4gICAgc2l0ZURhdGEsXG4gICAgY2xpZW50U3RhdHMsXG4gICAgaW5jcmVtZW50YWwsXG4gIH0gPSBzdGF0ZVxuXG4gIGxldCB7IENvbXAgfSA9IHN0YXRlXG5cbiAgY29uc3Qge1xuICAgIHNoYXJlZEhhc2hlc0J5UHJvcCxcbiAgICB0ZW1wbGF0ZSxcbiAgICBkYXRhLFxuICAgIHNoYXJlZERhdGEsXG4gICAgcGF0aDogcm91dGVQYXRoLFxuICAgIHJlbW92ZSxcbiAgfSA9IHJvdXRlXG5cbiAgaWYgKGluY3JlbWVudGFsICYmIHJlbW92ZSkge1xuICAgIGlmIChyb3V0ZS5wYXRoID09PSAnNDA0JyB8fCByb3V0ZS5wYXRoID09PSAnLycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFlvdSBhcmUgYXR0ZW1wdGluZyB0byBpbmNyZW1lbnRhbGx5IHJlbW92ZSB0aGUgJHtcbiAgICAgICAgICByb3V0ZS5wYXRoID09PSAnNDA0JyA/ICc0MDQnIDogJ2luZGV4J1xuICAgICAgICB9IHJvdXRlIGZyb20geW91ciBleHBvcnQuIFRoaXMgaXMgY3VycmVudGx5IG5vdCBzdXBwb3J0ZWQgKG9yIHJlY29tbWVuZGVkKSBieSBSZWFjdCBTdGF0aWMuYFxuICAgICAgKVxuICAgIH1cbiAgICBjb25zdCByZW1vdmVMb2NhdGlvbiA9IG5vZGVQYXRoLmpvaW4oY29uZmlnLnBhdGhzLkRJU1QsIHJvdXRlLnBhdGgpXG4gICAgcmV0dXJuIGZzLnJlbW92ZShyZW1vdmVMb2NhdGlvbilcbiAgfVxuXG4gIGNvbnN0IGJhc2VQYXRoID0gY2FjaGVkQmFzZVBhdGggfHwgKGNhY2hlZEJhc2VQYXRoID0gY29uZmlnLmJhc2VQYXRoKVxuXG4gIGNvbnN0IGhyZWZSZXBsYWNlID1cbiAgICBjYWNoZWRIcmVmUmVwbGFjZSB8fFxuICAgIChjYWNoZWRIcmVmUmVwbGFjZSA9IG5ldyBSZWdFeHAoXG4gICAgICBgKGhyZWY9W1wiJ10pXFxcXC8oJHtiYXNlUGF0aCA/IGAke2Jhc2VQYXRofVxcXFwvYCA6ICcnfSk/KFteXFxcXC9dKWAsXG4gICAgICAnZ20nXG4gICAgKSlcblxuICBjb25zdCBzcmNSZXBsYWNlID1cbiAgICBjYWNoZWRTcmNSZXBsYWNlIHx8XG4gICAgKGNhY2hlZFNyY1JlcGxhY2UgPSBuZXcgUmVnRXhwKFxuICAgICAgYChzcmM9W1wiJ10pXFxcXC8oJHtiYXNlUGF0aCA/IGAke2Jhc2VQYXRofVxcXFwvYCA6ICcnfSk/KFteXFxcXC9dKWAsXG4gICAgICAnZ20nXG4gICAgKSlcblxuICAvLyBUaGlzIHJvdXRlSW5mbyB3aWxsIGJlIHNhdmVkIHRvIGRpc2suIEl0IHNob3VsZCBvbmx5IGluY2x1ZGUgdGhlXG4gIC8vIGRhdGEgYW5kIGhhc2hlcyB0byBjb25zdHJ1Y3QgYWxsIG9mIHRoZSBwcm9wcyBsYXRlci5cbiAgY29uc3Qgcm91dGVJbmZvID0ge1xuICAgIHRlbXBsYXRlLFxuICAgIHNoYXJlZEhhc2hlc0J5UHJvcCxcbiAgICBkYXRhLFxuICAgIHBhdGg6IHJvdXRlUGF0aCxcbiAgfVxuXG4gIC8vIFRoaXMgZW1iZWRkZWRSb3V0ZUluZm8gd2lsbCBiZSBpbmxpbmVkIGludG8gdGhlIEhUTUwgZm9yIHRoaXMgcm91dGUuXG4gIC8vIEl0IHNob3VsZCBpbmNsdWRlIGFsbCBvZiB0aGUgZGF0YSwgaW5jbHVkaW5nIHNoYXJlZCBkYXRhXG4gIGNvbnN0IGVtYmVkZGVkUm91dGVJbmZvID0ge1xuICAgIC4uLnJvdXRlSW5mbyxcbiAgICBzaGFyZWREYXRhLFxuICAgIHNpdGVEYXRhLFxuICB9XG5cbiAgc3RhdGUgPSB7XG4gICAgLi4uc3RhdGUsXG4gICAgcm91dGVJbmZvLFxuICAgIGVtYmVkZGVkUm91dGVJbmZvLFxuICB9XG5cbiAgLy8gTWFrZSBhIHBsYWNlIHRvIGNvbGxlY3QgY2h1bmtzLCBtZXRhIGluZm8gYW5kIGhlYWQgdGFnc1xuICBjb25zdCBtZXRhID0ge31cbiAgY29uc3QgY2h1bmtOYW1lcyA9IFtdXG4gIGxldCBoZWFkID0ge31cbiAgbGV0IGNsaWVudFNjcmlwdHMgPSBbXVxuICBsZXQgY2xpZW50U3R5bGVTaGVldHMgPSBbXVxuICBsZXQgY2xpZW50Q3NzID0ge31cblxuICBsZXQgRmluYWxDb21wXG5cbiAgLy8gR2V0IHRoZSByZWFjdCBjb21wb25lbnQgZnJvbSB0aGUgQ29tcCBhbmRcbiAgLy8gcGFzcyBpdCB0aGUgZXhwb3J0IGNvbnRleHQuIFRoaXMgdXNlc1xuICAvLyByZWFjdENvbnRleHQgdW5kZXIgdGhlIGhvb2QgdG8gcGFzcyBkb3duXG4gIC8vIHRoZSBleHBvcnRDb250ZXh0LCBzaW5jZSByZWFjdCdzIG5ldyBjb250ZXh0XG4gIC8vIGFwaSBkb2Vzbid0IHN1cnZpdmUgYWNyb3NzIGJ1bmRsaW5nLlxuICBDb21wID0gY29uZmlnLmRpc2FibGVSdW50aW1lID8gQ29tcCA6IENvbXAoZW1iZWRkZWRSb3V0ZUluZm8pXG5cbiAgaWYgKHJvdXRlLnJlZGlyZWN0KSB7XG4gICAgRmluYWxDb21wID0gKCkgPT4gPFJlZGlyZWN0IGZyb21QYXRoPXtyb3V0ZS5wYXRofSB0bz17cm91dGUucmVkaXJlY3R9IC8+XG4gIH0gZWxzZSB7XG4gICAgRmluYWxDb21wID0gcHJvcHMgPT4gKFxuICAgICAgPFJlcG9ydENodW5rc1xuICAgICAgICByZXBvcnQ9e2NodW5rTmFtZSA9PiB7XG4gICAgICAgICAgLy8gaWYgd2UgYXJlIGJ1aWxkaW5nIHRvIGEgYWJzb2x1dGUgcGF0aCB3ZSBtdXN0IG1ha2UgdGhlIGRldGVjdGVkIGNodW5rTmFtZSByZWxhdGl2ZSBhbmQgbWF0Y2hpbmcgdG8gdGhlIG9uZSB3ZSBzZXQgaW4gZ2VuZXJhdGVUZW1wbGF0ZXNcbiAgICAgICAgICBpZiAoIWNvbmZpZy5wYXRocy5ESVNULnN0YXJ0c1dpdGgoY29uZmlnLnBhdGhzLlJPT1QpKSB7XG4gICAgICAgICAgICBjaHVua05hbWUgPSBhYnNvbHV0ZVRvUmVsYXRpdmVDaHVua05hbWUoXG4gICAgICAgICAgICAgIGNvbmZpZy5wYXRocy5ST09ULFxuICAgICAgICAgICAgICBjaHVua05hbWVcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjaHVua05hbWVzLnB1c2goY2h1bmtOYW1lKVxuICAgICAgICB9fVxuICAgICAgPlxuICAgICAgICA8Q29tcCB7Li4ucHJvcHN9IC8+XG4gICAgICA8L1JlcG9ydENodW5rcz5cbiAgICApXG4gIH1cblxuICBjb25zdCByZW5kZXJUb1N0cmluZ0FuZEV4dHJhY3QgPSBjb21wID0+IHtcbiAgICAvLyBSZW5kIHRoZSBhcHAgdG8gc3RyaW5nIVxuICAgIGNvbnN0IGFwcEh0bWwgPSByZW5kZXJUb1N0cmluZyhjb21wKVxuICAgIGNvbnN0IHsgc2NyaXB0cywgc3R5bGVzaGVldHMsIGNzcyB9ID0gZmx1c2hDaHVua3MoY2xpZW50U3RhdHMsIHtcbiAgICAgIGNodW5rTmFtZXMsXG4gICAgICBvdXRwdXRQYXRoOiBjb25maWcucGF0aHMuRElTVCxcbiAgICB9KVxuXG4gICAgY2xpZW50U2NyaXB0cyA9IHNjcmlwdHNcbiAgICBjbGllbnRTdHlsZVNoZWV0cyA9IHN0eWxlc2hlZXRzXG4gICAgY2xpZW50Q3NzID0gY3NzXG4gICAgLy8gRXh0cmFjdCBoZWFkIGNhbGxzIHVzaW5nIEhlbG1ldCBzeW5jaHJvbm91c2x5IHJpZ2h0IGFmdGVyIHJlbmRlclRvU3RyaW5nXG4gICAgLy8gdG8gbm90IGludHJvZHVjZSBhbnkgcmFjZSBjb25kaXRpb25zIGluIHRoZSBtZXRhIGRhdGEgcmVuZGVyaW5nXG4gICAgY29uc3QgaGVsbWV0ID0gSGVsbWV0LnJlbmRlclN0YXRpYygpXG4gICAgaGVhZCA9IHtcbiAgICAgIGh0bWxQcm9wczogaGVsbWV0Lmh0bWxBdHRyaWJ1dGVzLnRvQ29tcG9uZW50KCksXG4gICAgICBib2R5UHJvcHM6IGhlbG1ldC5ib2R5QXR0cmlidXRlcy50b0NvbXBvbmVudCgpLFxuICAgICAgYmFzZTogaGVsbWV0LmJhc2UudG9Db21wb25lbnQoKSxcbiAgICAgIGxpbms6IGhlbG1ldC5saW5rLnRvQ29tcG9uZW50KCksXG4gICAgICBtZXRhOiBoZWxtZXQubWV0YS50b0NvbXBvbmVudCgpLFxuICAgICAgbm9zY3JpcHQ6IGhlbG1ldC5ub3NjcmlwdC50b0NvbXBvbmVudCgpLFxuICAgICAgc2NyaXB0OiBoZWxtZXQuc2NyaXB0LnRvQ29tcG9uZW50KCksXG4gICAgICBzdHlsZTogaGVsbWV0LnN0eWxlLnRvQ29tcG9uZW50KCksXG4gICAgICB0aXRsZTogaGVsbWV0LnRpdGxlLnRvQ29tcG9uZW50KCksXG4gICAgfVxuXG4gICAgcmV0dXJuIGFwcEh0bWxcbiAgfVxuXG4gIGxldCBhcHBIdG1sXG5cbiAgc3RhdGUgPSB7XG4gICAgLi4uc3RhdGUsXG4gICAgbWV0YSxcbiAgfVxuXG4gIHRyeSB7XG4gICAgRmluYWxDb21wID0gYXdhaXQgcGx1Z2lucy5iZWZvcmVSZW5kZXJUb0VsZW1lbnQoRmluYWxDb21wLCBzdGF0ZSlcblxuICAgIGlmIChjb25maWcucmVuZGVyVG9FbGVtZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBjb25maWcucmVuZGVyVG9FbGVtZW50IGhhcyBiZWVuIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgdGhlICdiZWZvcmVSZW5kZXJUb0VsZW1lbnQnIG9yICdiZWZvcmVSZW5kZXJUb0h0bWwnIGhvb2tzIGluc3RlYWQuYFxuICAgICAgKVxuICAgIH1cblxuICAgIGxldCBSZW5kZXJlZENvbXAgPSA8RmluYWxDb21wIC8+XG5cbiAgICAvLyBSdW4gdGhlIGJlZm9yZVJlbmRlclRvSHRtbCBob29rXG4gICAgLy8gUnVtIHRoZSBIdG1sIGhvb2tcbiAgICBSZW5kZXJlZENvbXAgPSBhd2FpdCBwbHVnaW5zLmJlZm9yZVJlbmRlclRvSHRtbChSZW5kZXJlZENvbXAsIHN0YXRlKVxuXG4gICAgaWYgKGNvbmZpZy5yZW5kZXJUb0h0bWwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYGNvbmZpZy5yZW5kZXJUb0h0bWwgaGFzIGJlZW4gZGVwcmVjYXRlZCBpbiBmYXZvciBvZiB0aGUgJ2JlZm9yZVJlbmRlclRvSHRtbCcgb3IgJ2JlZm9yZUh0bWxUb0RvY3VtZW50JyBob29rcyBpbnN0ZWFkLmBcbiAgICAgIClcbiAgICB9XG5cbiAgICBhcHBIdG1sID0gcmVuZGVyVG9TdHJpbmdBbmRFeHRyYWN0KFJlbmRlcmVkQ29tcClcblxuICAgIGFwcEh0bWwgPSBhd2FpdCBwbHVnaW5zLmJlZm9yZUh0bWxUb0RvY3VtZW50KGFwcEh0bWwsIHN0YXRlKVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvci50aGVuKSB7XG4gICAgICBlcnJvci5tZXNzYWdlID1cbiAgICAgICAgJ0NvbXBvbmVudHMgYXJlIG5vdCBhbGxvd2VkIHRvIHN1c3BlbmQgZHVyaW5nIHN0YXRpYyBleHBvcnQuIFBsZWFzZSBtYWtlIGl0cyBkYXRhIGF2YWlsYWJsZSBzeW5jaHJvbm91c2x5IGFuZCB0cnkgYWdhaW4hJ1xuICAgIH1cbiAgICBlcnJvci5tZXNzYWdlID0gYEZhaWxlZCBleHBvcnRpbmcgSFRNTCBmb3IgVVJMICR7cm91dGUucGF0aH0gKCR7XG4gICAgICByb3V0ZS50ZW1wbGF0ZVxuICAgIH0pOiAke2Vycm9yLm1lc3NhZ2V9YFxuICAgIHRocm93IGVycm9yXG4gIH1cblxuICBzdGF0ZSA9IHtcbiAgICAuLi5zdGF0ZSxcbiAgICBoZWFkLFxuICAgIGNsaWVudFNjcmlwdHMsXG4gICAgY2xpZW50U3R5bGVTaGVldHMsXG4gICAgY2xpZW50Q3NzLFxuICB9XG5cbiAgY29uc3QgRG9jdW1lbnRIdG1sID0gcmVuZGVyVG9TdGF0aWNNYXJrdXAoXG4gICAgPERvY3VtZW50VGVtcGxhdGVcbiAgICAgIEh0bWw9e2F3YWl0IG1ha2VIdG1sV2l0aE1ldGEoc3RhdGUpfVxuICAgICAgSGVhZD17YXdhaXQgbWFrZUhlYWRXaXRoTWV0YShzdGF0ZSl9XG4gICAgICBCb2R5PXthd2FpdCBtYWtlQm9keVdpdGhNZXRhKHN0YXRlKX1cbiAgICAgIHN0YXRlPXtzdGF0ZX1cbiAgICA+XG4gICAgICA8ZGl2IGlkPVwicm9vdFwiIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MPXt7IF9faHRtbDogYXBwSHRtbCB9fSAvPlxuICAgIDwvRG9jdW1lbnRUZW1wbGF0ZT5cbiAgKVxuXG4gIC8vIFJlbmRlciB0aGUgaHRtbCBmb3IgdGhlIHBhZ2UgaW5zaWRlIG9mIHRoZSBiYXNlIGRvY3VtZW50LlxuICBsZXQgaHRtbCA9IGA8IURPQ1RZUEUgaHRtbD4ke0RvY3VtZW50SHRtbH1gXG5cbiAgaHRtbCA9IGF3YWl0IHBsdWdpbnMuYmVmb3JlRG9jdW1lbnRUb0ZpbGUoaHRtbCwgc3RhdGUpXG5cbiAgLy8gSWYgdGhlIHNpdGVSb290IGlzIHNldCBhbmQgd2UncmUgbm90IGluIHN0YWdpbmcsIHByZWZpeCBhbGwgYWJzb2x1dGUgVVJMc1xuICAvLyB3aXRoIHRoZSBzaXRlUm9vdFxuICBjb25zdCBwdWJsaWNQYXRoID0gbWFrZVBhdGhBYnNvbHV0ZShwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfUFVCTElDX1BBVEgpXG4gIGlmIChwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfRElTQUJMRV9ST1VURV9QUkVGSVhJTkcgIT09ICd0cnVlJykge1xuICAgIGh0bWwgPSBodG1sLnJlcGxhY2UoaHJlZlJlcGxhY2UsIGAkMSR7cHVibGljUGF0aH0kM2ApXG4gIH1cblxuICBodG1sID0gaHRtbC5yZXBsYWNlKHNyY1JlcGxhY2UsIGAkMSR7cHVibGljUGF0aH0kM2ApXG5cbiAgLy8gSWYgdGhlIHJvdXRlIGlzIGEgNDA0IHBhZ2UsIHdyaXRlIGl0IGRpcmVjdGx5IHRvIDQwNC5odG1sLCBpbnN0ZWFkIG9mXG4gIC8vIGluc2lkZSBhIGRpcmVjdG9yeS5cbiAgY29uc3QgaHRtbEZpbGVuYW1lID1cbiAgICByb3V0ZS5wYXRoID09PSAnNDA0J1xuICAgICAgPyBub2RlUGF0aC5qb2luKGNvbmZpZy5wYXRocy5ESVNULCAnNDA0Lmh0bWwnKVxuICAgICAgOiBub2RlUGF0aC5qb2luKGNvbmZpZy5wYXRocy5ESVNULCByb3V0ZS5wYXRoLCAnaW5kZXguaHRtbCcpXG5cbiAgLy8gTWFrZSB0aGUgcm91dGVJbmZvIHNpdCByaWdodCBuZXh0IHRvIGl0cyBjb21wYW5pb24gaHRtbCBmaWxlXG4gIGNvbnN0IHJvdXRlSW5mb0ZpbGVuYW1lID0gbm9kZVBhdGguam9pbihcbiAgICBjb25maWcucGF0aHMuRElTVCxcbiAgICByb3V0ZS5wYXRoLFxuICAgICdyb3V0ZUluZm8uanNvbidcbiAgKVxuXG4gIGNvbnN0IHJlcyA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICBmcy5vdXRwdXRGaWxlKGh0bWxGaWxlbmFtZSwgaHRtbCksXG4gICAgIXJvdXRlLnJlZGlyZWN0XG4gICAgICA/IGZzLm91dHB1dEpzb24ocm91dGVJbmZvRmlsZW5hbWUsIHJvdXRlSW5mbylcbiAgICAgIDogUHJvbWlzZS5yZXNvbHZlKCksXG4gIF0pXG4gIHJldHVybiByZXNcbn0pXG4iXX0=