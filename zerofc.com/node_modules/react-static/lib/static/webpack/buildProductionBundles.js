"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = buildProductionBundles;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _webpack = _interopRequireDefault(require("webpack"));

var _chalk = _interopRequireDefault(require("chalk"));

var _makeWebpackConfig = _interopRequireDefault(require("./makeWebpackConfig"));

var _clientStats = require("../clientStats");

var _utils = require("../../utils");

/* eslint-disable import/no-dynamic-require, react/no-danger, import/no-mutable-exports */
//
function buildProductionBundles(_x) {
  return _buildProductionBundles.apply(this, arguments);
}

function _buildProductionBundles() {
  _buildProductionBundles = (0, _asyncToGenerator2.default)(
  /*#__PURE__*/
  _regenerator.default.mark(function _callee3(state) {
    var allWebpackConfigs;
    return _regenerator.default.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            // Build static pages and JSON
            console.log('Bundling App...');
            (0, _utils.time)(_chalk.default.green("[\u2713] App Bundled"));
            _context3.next = 4;
            return (0, _makeWebpackConfig.default)(state);

          case 4:
            _context3.t0 = _context3.sent;
            _context3.next = 7;
            return (0, _makeWebpackConfig.default)((0, _objectSpread2.default)({}, state, {
              stage: 'node'
            }));

          case 7:
            _context3.t1 = _context3.sent;
            allWebpackConfigs = [_context3.t0, _context3.t1];
            _context3.next = 11;
            return new Promise(
            /*#__PURE__*/
            function () {
              var _ref = (0, _asyncToGenerator2.default)(
              /*#__PURE__*/
              _regenerator.default.mark(function _callee2(resolve, reject) {
                return _regenerator.default.wrap(function _callee2$(_context2) {
                  while (1) {
                    switch (_context2.prev = _context2.next) {
                      case 0:
                        (0, _webpack.default)(allWebpackConfigs).run(
                        /*#__PURE__*/
                        function () {
                          var _ref2 = (0, _asyncToGenerator2.default)(
                          /*#__PURE__*/
                          _regenerator.default.mark(function _callee(err, stats) {
                            var _stats$stats, prodStats, nodeStats, checkBuildStats;

                            return _regenerator.default.wrap(function _callee$(_context) {
                              while (1) {
                                switch (_context.prev = _context.next) {
                                  case 0:
                                    checkBuildStats = function _ref3(stage, stageStats) {
                                      var buildErrors = stageStats.hasErrors();
                                      var buildWarnings = stageStats.hasWarnings();

                                      if (buildErrors || buildWarnings) {
                                        console.log(stageStats.toString({
                                          context: state.config.context,
                                          performance: false,
                                          hash: false,
                                          timings: true,
                                          entrypoints: false,
                                          chunkOrigins: false,
                                          chunkModules: false,
                                          colors: true
                                        }));

                                        if (buildErrors) {
                                          console.log(_chalk.default.red.bold("\n                => There were ERRORS during the ".concat(stage, " build stage! :(\n                => Fix them and try again!\n              ")));
                                        } else if (buildWarnings) {
                                          console.log(_chalk.default.yellow("\n=> There were WARNINGS during the ".concat(stage, " build stage. Your site will still function, but you may achieve better performance by addressing the warnings above.\n")));
                                        }
                                      }
                                    };

                                    if (!err) {
                                      _context.next = 5;
                                      break;
                                    }

                                    console.log(_chalk.default.red(err.stack || err));

                                    if (err.details) {
                                      console.log(_chalk.default.red(err.details));
                                    }

                                    return _context.abrupt("return", reject(err));

                                  case 5:
                                    stats.toJson('verbose');
                                    _stats$stats = (0, _slicedToArray2.default)(stats.stats, 2), prodStats = _stats$stats[0], nodeStats = _stats$stats[1];
                                    checkBuildStats('prod', prodStats);
                                    checkBuildStats('node', nodeStats);
                                    _context.next = 11;
                                    return (0, _clientStats.outputClientStats)(state, prodStats.toJson());

                                  case 11:
                                    state = _context.sent;
                                    resolve(state);

                                  case 13:
                                  case "end":
                                    return _context.stop();
                                }
                              }
                            }, _callee);
                          }));

                          return function (_x4, _x5) {
                            return _ref2.apply(this, arguments);
                          };
                        }());

                      case 1:
                      case "end":
                        return _context2.stop();
                    }
                  }
                }, _callee2);
              }));

              return function (_x2, _x3) {
                return _ref.apply(this, arguments);
              };
            }());

          case 11:
            state = _context3.sent;
            (0, _utils.timeEnd)(_chalk.default.green("[\u2713] App Bundled"));
            return _context3.abrupt("return", state);

          case 14:
          case "end":
            return _context3.stop();
        }
      }
    }, _callee3);
  }));
  return _buildProductionBundles.apply(this, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGF0aWMvd2VicGFjay9idWlsZFByb2R1Y3Rpb25CdW5kbGVzLmpzIl0sIm5hbWVzIjpbImJ1aWxkUHJvZHVjdGlvbkJ1bmRsZXMiLCJzdGF0ZSIsImNvbnNvbGUiLCJsb2ciLCJjaGFsayIsImdyZWVuIiwic3RhZ2UiLCJhbGxXZWJwYWNrQ29uZmlncyIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwicnVuIiwiZXJyIiwic3RhdHMiLCJjaGVja0J1aWxkU3RhdHMiLCJzdGFnZVN0YXRzIiwiYnVpbGRFcnJvcnMiLCJoYXNFcnJvcnMiLCJidWlsZFdhcm5pbmdzIiwiaGFzV2FybmluZ3MiLCJ0b1N0cmluZyIsImNvbnRleHQiLCJjb25maWciLCJwZXJmb3JtYW5jZSIsImhhc2giLCJ0aW1pbmdzIiwiZW50cnlwb2ludHMiLCJjaHVua09yaWdpbnMiLCJjaHVua01vZHVsZXMiLCJjb2xvcnMiLCJyZWQiLCJib2xkIiwieWVsbG93Iiwic3RhY2siLCJkZXRhaWxzIiwidG9Kc29uIiwicHJvZFN0YXRzIiwibm9kZVN0YXRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQU5BO0FBR0E7U0FLOEJBLHNCOzs7Ozs7OzRCQUFmLGtCQUFzQ0MsS0FBdEM7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQ2I7QUFDQUMsWUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksaUJBQVo7QUFDQSw2QkFBS0MsZUFBTUMsS0FBTixDQUFZLHNCQUFaLENBQUw7QUFIYTtBQUFBLG1CQU1MLGdDQUFrQkosS0FBbEIsQ0FOSzs7QUFBQTtBQUFBO0FBQUE7QUFBQSxtQkFPTCxnRUFBdUJBLEtBQXZCO0FBQThCSyxjQUFBQSxLQUFLLEVBQUU7QUFBckMsZUFQSzs7QUFBQTtBQUFBO0FBS1BDLFlBQUFBLGlCQUxPO0FBQUE7QUFBQSxtQkFVQyxJQUFJQyxPQUFKO0FBQUE7QUFBQTtBQUFB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b3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlLCByZWFjdC9uby1kYW5nZXIsIGltcG9ydC9uby1tdXRhYmxlLWV4cG9ydHMgKi9cbmltcG9ydCB3ZWJwYWNrIGZyb20gJ3dlYnBhY2snXG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnXG4vL1xuaW1wb3J0IG1ha2VXZWJwYWNrQ29uZmlnIGZyb20gJy4vbWFrZVdlYnBhY2tDb25maWcnXG5pbXBvcnQgeyBvdXRwdXRDbGllbnRTdGF0cyB9IGZyb20gJy4uL2NsaWVudFN0YXRzJ1xuaW1wb3J0IHsgdGltZSwgdGltZUVuZCB9IGZyb20gJy4uLy4uL3V0aWxzJ1xuXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBidWlsZFByb2R1Y3Rpb25CdW5kbGVzKHN0YXRlKSB7XG4gIC8vIEJ1aWxkIHN0YXRpYyBwYWdlcyBhbmQgSlNPTlxuICBjb25zb2xlLmxvZygnQnVuZGxpbmcgQXBwLi4uJylcbiAgdGltZShjaGFsay5ncmVlbignW1xcdTI3MTNdIEFwcCBCdW5kbGVkJykpXG5cbiAgY29uc3QgYWxsV2VicGFja0NvbmZpZ3MgPSBbXG4gICAgYXdhaXQgbWFrZVdlYnBhY2tDb25maWcoc3RhdGUpLFxuICAgIGF3YWl0IG1ha2VXZWJwYWNrQ29uZmlnKHsgLi4uc3RhdGUsIHN0YWdlOiAnbm9kZScgfSksIC8vIE1ha2Ugc3VyZSB3ZSdyZSBidWlsZGluZyB0aGUgbm9kZSBjb25maWdcbiAgXVxuXG4gIHN0YXRlID0gYXdhaXQgbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHdlYnBhY2soYWxsV2VicGFja0NvbmZpZ3MpLnJ1bihhc3luYyAoZXJyLCBzdGF0cykgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5yZWQoZXJyLnN0YWNrIHx8IGVycikpXG4gICAgICAgIGlmIChlcnIuZGV0YWlscykge1xuICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnJlZChlcnIuZGV0YWlscykpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpXG4gICAgICB9XG5cbiAgICAgIHN0YXRzLnRvSnNvbigndmVyYm9zZScpXG5cbiAgICAgIGNvbnN0IFtwcm9kU3RhdHMsIG5vZGVTdGF0c10gPSBzdGF0cy5zdGF0c1xuXG4gICAgICBjaGVja0J1aWxkU3RhdHMoJ3Byb2QnLCBwcm9kU3RhdHMpXG4gICAgICBjaGVja0J1aWxkU3RhdHMoJ25vZGUnLCBub2RlU3RhdHMpXG5cbiAgICAgIGZ1bmN0aW9uIGNoZWNrQnVpbGRTdGF0cyhzdGFnZSwgc3RhZ2VTdGF0cykge1xuICAgICAgICBjb25zdCBidWlsZEVycm9ycyA9IHN0YWdlU3RhdHMuaGFzRXJyb3JzKClcbiAgICAgICAgY29uc3QgYnVpbGRXYXJuaW5ncyA9IHN0YWdlU3RhdHMuaGFzV2FybmluZ3MoKVxuXG4gICAgICAgIGlmIChidWlsZEVycm9ycyB8fCBidWlsZFdhcm5pbmdzKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICBzdGFnZVN0YXRzLnRvU3RyaW5nKHtcbiAgICAgICAgICAgICAgY29udGV4dDogc3RhdGUuY29uZmlnLmNvbnRleHQsXG4gICAgICAgICAgICAgIHBlcmZvcm1hbmNlOiBmYWxzZSxcbiAgICAgICAgICAgICAgaGFzaDogZmFsc2UsXG4gICAgICAgICAgICAgIHRpbWluZ3M6IHRydWUsXG4gICAgICAgICAgICAgIGVudHJ5cG9pbnRzOiBmYWxzZSxcbiAgICAgICAgICAgICAgY2h1bmtPcmlnaW5zOiBmYWxzZSxcbiAgICAgICAgICAgICAgY2h1bmtNb2R1bGVzOiBmYWxzZSxcbiAgICAgICAgICAgICAgY29sb3JzOiB0cnVlLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApXG4gICAgICAgICAgaWYgKGJ1aWxkRXJyb3JzKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgY2hhbGsucmVkLmJvbGQoYFxuICAgICAgICAgICAgICAgID0+IFRoZXJlIHdlcmUgRVJST1JTIGR1cmluZyB0aGUgJHtzdGFnZX0gYnVpbGQgc3RhZ2UhIDooXG4gICAgICAgICAgICAgICAgPT4gRml4IHRoZW0gYW5kIHRyeSBhZ2FpbiFcbiAgICAgICAgICAgICAgYClcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9IGVsc2UgaWYgKGJ1aWxkV2FybmluZ3MpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICBjaGFsay55ZWxsb3coYFxuPT4gVGhlcmUgd2VyZSBXQVJOSU5HUyBkdXJpbmcgdGhlICR7c3RhZ2V9IGJ1aWxkIHN0YWdlLiBZb3VyIHNpdGUgd2lsbCBzdGlsbCBmdW5jdGlvbiwgYnV0IHlvdSBtYXkgYWNoaWV2ZSBiZXR0ZXIgcGVyZm9ybWFuY2UgYnkgYWRkcmVzc2luZyB0aGUgd2FybmluZ3MgYWJvdmUuXG5gKVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBzdGF0ZSA9IGF3YWl0IG91dHB1dENsaWVudFN0YXRzKHN0YXRlLCBwcm9kU3RhdHMudG9Kc29uKCkpXG4gICAgICByZXNvbHZlKHN0YXRlKVxuICAgIH0pXG4gIH0pXG5cbiAgdGltZUVuZChjaGFsay5ncmVlbignW1xcdTI3MTNdIEFwcCBCdW5kbGVkJykpXG5cbiAgcmV0dXJuIHN0YXRlXG59XG4iXX0=