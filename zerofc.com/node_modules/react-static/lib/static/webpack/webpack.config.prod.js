"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _webpack = _interopRequireDefault(require("webpack"));

var _path = _interopRequireDefault(require("path"));

var _caseSensitivePathsWebpackPlugin = _interopRequireDefault(require("case-sensitive-paths-webpack-plugin"));

var _webpackBundleAnalyzer = require("webpack-bundle-analyzer");

var _terserWebpackPlugin = _interopRequireDefault(require("terser-webpack-plugin"));

var _webpackNodeExternals = _interopRequireDefault(require("webpack-node-externals"));

var _extractCssChunksWebpackPlugin = _interopRequireDefault(require("extract-css-chunks-webpack-plugin"));

var _optimizeCssAssetsWebpackPlugin = _interopRequireDefault(require("optimize-css-assets-webpack-plugin"));

var _resolveFrom = _interopRequireDefault(require("resolve-from"));

var _rules = _interopRequireDefault(require("./rules"));

//
function common(state) {
  var analyze = state.analyze,
      config = state.config,
      debug = state.debug;
  var _config$paths = config.paths,
      ROOT = _config$paths.ROOT,
      DIST = _config$paths.DIST,
      NODE_MODULES = _config$paths.NODE_MODULES,
      SRC = _config$paths.SRC,
      ASSETS = _config$paths.ASSETS;
  process.env.REACT_STATIC_ENTRY_PATH = _path.default.resolve(ROOT, config.entry);
  process.env.REACT_STATIC_SITE_ROOT = config.siteRoot;
  process.env.REACT_STATIC_BASE_PATH = config.basePath;
  process.env.REACT_STATIC_PUBLIC_PATH = config.publicPath;
  process.env.REACT_STATIC_ASSETS_PATH = config.assetsPath;

  if (!DIST.startsWith(ROOT)) {
    // we build outside of project dir, so reset some paths
    process.env.REACT_STATIC_ASSETS_PATH = config.assetsPath.replace(DIST, '');
  }

  var splitChunks = {
    chunks: 'all',
    minSize: 10000,
    minChunks: 1,
    maxAsyncRequests: 5,
    maxInitialRequests: 5,
    automaticNameDelimiter: '~',
    name: true,
    cacheGroups: {
      vendors: {
        test: /[\\/]node_modules[\\/]/,
        priority: -10,
        chunks: 'all'
      },
      default: {
        minChunks: 2,
        priority: -20,
        reuseExistingChunk: true
      }
    }
  };
  var extrackCSSChunks = new _extractCssChunksWebpackPlugin.default({
    filename: '[name].[chunkHash:8].css',
    chunkFilename: '[id].[chunkHash:8].css'
  });

  if (!config.extractCssChunks) {
    splitChunks.cacheGroups = {
      styles: {
        name: 'styles',
        test: /\.css$/,
        chunks: 'all',
        enforce: true
      }
    };
    extrackCSSChunks = new _extractCssChunksWebpackPlugin.default({
      filename: '[name].[chunkHash:8].css'
    });
  }

  return {
    mode: 'production',
    context: _path.default.resolve(__dirname, '../../../node_modules'),
    entry: config.disableRuntime ? _path.default.resolve(ROOT, config.entry) : [require.resolve('../../bootstrapPlugins'), require.resolve('../../bootstrapTemplates'), require.resolve('../../bootstrapApp')],
    output: {
      filename: '[name].[hash:8].js',
      // dont use chunkhash, its not a chunk
      chunkFilename: 'templates/[name].[chunkHash:8].js',
      path: ASSETS,
      publicPath: process.env.REACT_STATIC_ASSETS_PATH || '/'
    },
    optimization: {
      sideEffects: true,
      minimize: true,
      minimizer: [new _terserWebpackPlugin.default((0, _objectSpread2.default)({
        cache: true,
        parallel: true,
        exclude: /\.min\.js/
      }, config.terser, {
        sourceMap: config.productionSourceMaps || config.terser.sourceMap || debug,
        terserOptions: (0, _objectSpread2.default)({
          ie8: false
        }, config.terser.terserOptions, {
          mangle: (0, _objectSpread2.default)({
            safari10: true
          }, config.terser.terserOptions.mangle),
          parse: (0, _objectSpread2.default)({
            ecma: 8
          }, config.terser.terserOptions.parse),
          compress: (0, _objectSpread2.default)({
            ecma: 5
          }, config.terser.terserOptions.compress),
          output: (0, _objectSpread2.default)({
            ecma: 5
          }, config.terser.terserOptions.output)
        })
      })), new _optimizeCssAssetsWebpackPlugin.default({})],
      splitChunks: splitChunks
    },
    performance: {
      maxEntrypointSize: 300000
    },
    module: {
      rules: (0, _rules.default)({
        config: config,
        stage: 'prod',
        isNode: false
      }),
      strictExportPresence: true
    },
    resolve: {
      modules: [NODE_MODULES, SRC, DIST].concat((0, _toConsumableArray2.default)([NODE_MODULES, SRC, DIST].map(function (d) {
        return DIST.startsWith(ROOT) ? _path.default.relative(__dirname, d) : _path.default.resolve(d);
      })), ['node_modules']),
      extensions: ['.wasm', '.mjs', '.js', '.json', '.jsx'],
      alias: {
        react: (0, _resolveFrom.default)(config.paths.NODE_MODULES, 'react'),
        'react-dom': (0, _resolveFrom.default)(config.paths.NODE_MODULES, 'react-dom'),
        'react-universal-component': (0, _resolveFrom.default)(__dirname, 'react-universal-component')
      }
    },
    externals: [],
    target: undefined,
    plugins: [new _webpack.default.EnvironmentPlugin(process.env), extrackCSSChunks, new _caseSensitivePathsWebpackPlugin.default(), analyze && new _webpackBundleAnalyzer.BundleAnalyzerPlugin()].filter(function (d) {
      return d;
    }),
    devtool: debug || config.productionSourceMaps ? 'source-map' : false
  };
}

function _default(state) {
  var stage = state.stage,
      paths = state.config.paths;
  var result = common(state);
  if (stage !== 'node') return result; // Node only!!!

  result.output.filename = 'static-app.js';
  result.output.path = paths.ARTIFACTS;
  result.output.libraryTarget = 'umd';
  result.optimization.minimize = false;
  result.optimization.minimizer = [];
  result.target = 'node';
  result.devtool = false;
  result.externals = [new RegExp("".concat(paths.PLUGINS)), function (context, request, callback) {
    var resolved = _path.default.resolve(context, request);

    if ([/react-static\/lib\/browser/, /webpack-flush-chunks/].some(function (d) {
      return d.test(resolved);
    })) {
      return callback(null, "commonjs ".concat(resolved));
    }

    callback();
  }, (0, _webpackNodeExternals.default)()];
  result.module.rules = (0, _rules.default)(state);
  result.plugins = [new _webpack.default.EnvironmentPlugin(process.env), new _caseSensitivePathsWebpackPlugin.default(), new _webpack.default.optimize.LimitChunkCountPlugin({
    maxChunks: 1
  })];
  return result;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGF0aWMvd2VicGFjay93ZWJwYWNrLmNvbmZpZy5wcm9kLmpzIl0sIm5hbWVzIjpbImNvbW1vbiIsInN0YXRlIiwiYW5hbHl6ZSIsImNvbmZpZyIsImRlYnVnIiwicGF0aHMiLCJST09UIiwiRElTVCIsIk5PREVfTU9EVUxFUyIsIlNSQyIsIkFTU0VUUyIsInByb2Nlc3MiLCJlbnYiLCJSRUFDVF9TVEFUSUNfRU5UUllfUEFUSCIsInBhdGgiLCJyZXNvbHZlIiwiZW50cnkiLCJSRUFDVF9TVEFUSUNfU0lURV9ST09UIiwic2l0ZVJvb3QiLCJSRUFDVF9TVEFUSUNfQkFTRV9QQVRIIiwiYmFzZVBhdGgiLCJSRUFDVF9TVEFUSUNfUFVCTElDX1BBVEgiLCJwdWJsaWNQYXRoIiwiUkVBQ1RfU1RBVElDX0FTU0VUU19QQVRIIiwiYXNzZXRzUGF0aCIsInN0YXJ0c1dpdGgiLCJyZXBsYWNlIiwic3BsaXRDaHVua3MiLCJjaHVua3MiLCJtaW5TaXplIiwibWluQ2h1bmtzIiwibWF4QXN5bmNSZXF1ZXN0cyIsIm1heEluaXRpYWxSZXF1ZXN0cyIsImF1dG9tYXRpY05hbWVEZWxpbWl0ZXIiLCJuYW1lIiwiY2FjaGVHcm91cHMiLCJ2ZW5kb3JzIiwidGVzdCIsInByaW9yaXR5IiwiZGVmYXVsdCIsInJldXNlRXhpc3RpbmdDaHVuayIsImV4dHJhY2tDU1NDaHVua3MiLCJFeHRyYWN0Q3NzQ2h1bmtzIiwiZmlsZW5hbWUiLCJjaHVua0ZpbGVuYW1lIiwiZXh0cmFjdENzc0NodW5rcyIsInN0eWxlcyIsImVuZm9yY2UiLCJtb2RlIiwiY29udGV4dCIsIl9fZGlybmFtZSIsImRpc2FibGVSdW50aW1lIiwicmVxdWlyZSIsIm91dHB1dCIsIm9wdGltaXphdGlvbiIsInNpZGVFZmZlY3RzIiwibWluaW1pemUiLCJtaW5pbWl6ZXIiLCJUZXJzZXJQbHVnaW4iLCJjYWNoZSIsInBhcmFsbGVsIiwiZXhjbHVkZSIsInRlcnNlciIsInNvdXJjZU1hcCIsInByb2R1Y3Rpb25Tb3VyY2VNYXBzIiwidGVyc2VyT3B0aW9ucyIsImllOCIsIm1hbmdsZSIsInNhZmFyaTEwIiwicGFyc2UiLCJlY21hIiwiY29tcHJlc3MiLCJPcHRpbWl6ZUNTU0Fzc2V0c1BsdWdpbiIsInBlcmZvcm1hbmNlIiwibWF4RW50cnlwb2ludFNpemUiLCJtb2R1bGUiLCJydWxlcyIsInN0YWdlIiwiaXNOb2RlIiwic3RyaWN0RXhwb3J0UHJlc2VuY2UiLCJtb2R1bGVzIiwibWFwIiwiZCIsInJlbGF0aXZlIiwiZXh0ZW5zaW9ucyIsImFsaWFzIiwicmVhY3QiLCJleHRlcm5hbHMiLCJ0YXJnZXQiLCJ1bmRlZmluZWQiLCJwbHVnaW5zIiwid2VicGFjayIsIkVudmlyb25tZW50UGx1Z2luIiwiQ2FzZVNlbnNpdGl2ZVBhdGhzUGx1Z2luIiwiQnVuZGxlQW5hbHl6ZXJQbHVnaW4iLCJmaWx0ZXIiLCJkZXZ0b29sIiwicmVzdWx0IiwiQVJUSUZBQ1RTIiwibGlicmFyeVRhcmdldCIsIlJlZ0V4cCIsIlBMVUdJTlMiLCJyZXF1ZXN0IiwiY2FsbGJhY2siLCJyZXNvbHZlZCIsInNvbWUiLCJvcHRpbWl6ZSIsIkxpbWl0Q2h1bmtDb3VudFBsdWdpbiIsIm1heENodW5rcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQURBO0FBR0EsU0FBU0EsTUFBVCxDQUFnQkMsS0FBaEIsRUFBdUI7QUFBQSxNQUNiQyxPQURhLEdBQ2NELEtBRGQsQ0FDYkMsT0FEYTtBQUFBLE1BQ0pDLE1BREksR0FDY0YsS0FEZCxDQUNKRSxNQURJO0FBQUEsTUFDSUMsS0FESixHQUNjSCxLQURkLENBQ0lHLEtBREo7QUFBQSxzQkFFNkJELE1BQU0sQ0FBQ0UsS0FGcEM7QUFBQSxNQUViQyxJQUZhLGlCQUViQSxJQUZhO0FBQUEsTUFFUEMsSUFGTyxpQkFFUEEsSUFGTztBQUFBLE1BRURDLFlBRkMsaUJBRURB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QUFEOEIsR0FBM0MsQ0FIZSxDQUFqQjtBQU9BLFNBQU9YLE1BQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB3ZWJwYWNrIGZyb20gJ3dlYnBhY2snXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IENhc2VTZW5zaXRpdmVQYXRoc1BsdWdpbiBmcm9tICdjYXNlLXNlbnNpdGl2ZS1wYXRocy13ZWJwYWNrLXBsdWdpbidcbmltcG9ydCB7IEJ1bmRsZUFuYWx5emVyUGx1Z2luIH0gZnJvbSAnd2VicGFjay1idW5kbGUtYW5hbHl6ZXInXG5pbXBvcnQgVGVyc2VyUGx1Z2luIGZyb20gJ3RlcnNlci13ZWJwYWNrLXBsdWdpbidcbmltcG9ydCBub2RlRXh0ZXJuYWxzIGZyb20gJ3dlYnBhY2stbm9kZS1leHRlcm5hbHMnXG5pbXBvcnQgRXh0cmFjdENzc0NodW5rcyBmcm9tICdleHRyYWN0LWNzcy1jaHVua3Mtd2VicGFjay1wbHVnaW4nXG5pbXBvcnQgT3B0aW1pemVDU1NBc3NldHNQbHVnaW4gZnJvbSAnb3B0aW1pemUtY3NzLWFzc2V0cy13ZWJwYWNrLXBsdWdpbidcbmltcG9ydCByZXNvbHZlRnJvbSBmcm9tICdyZXNvbHZlLWZyb20nXG4vL1xuaW1wb3J0IHJ1bGVzIGZyb20gJy4vcnVsZXMnXG5cbmZ1bmN0aW9uIGNvbW1vbihzdGF0ZSkge1xuICBjb25zdCB7IGFuYWx5emUsIGNvbmZpZywgZGVidWcgfSA9IHN0YXRlXG4gIGNvbnN0IHsgUk9PVCwgRElTVCwgTk9ERV9NT0RVTEVTLCBTUkMsIEFTU0VUUyB9ID0gY29uZmlnLnBhdGhzXG5cbiAgcHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX0VOVFJZX1BBVEggPSBwYXRoLnJlc29sdmUoUk9PVCwgY29uZmlnLmVudHJ5KVxuICBwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfU0lURV9ST09UID0gY29uZmlnLnNpdGVSb290XG4gIHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19CQVNFX1BBVEggPSBjb25maWcuYmFzZVBhdGhcbiAgcHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX1BVQkxJQ19QQVRIID0gY29uZmlnLnB1YmxpY1BhdGhcbiAgcHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX0FTU0VUU19QQVRIID0gY29uZmlnLmFzc2V0c1BhdGhcblxuICBpZiAoIURJU1Quc3RhcnRzV2l0aChST09UKSkge1xuICAgIC8vIHdlIGJ1aWxkIG91dHNpZGUgb2YgcHJvamVjdCBkaXIsIHNvIHJlc2V0IHNvbWUgcGF0aHNcbiAgICBwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfQVNTRVRTX1BBVEggPSBjb25maWcuYXNzZXRzUGF0aC5yZXBsYWNlKERJU1QsICcnKVxuICB9XG5cbiAgY29uc3Qgc3BsaXRDaHVua3MgPSB7XG4gICAgY2h1bmtzOiAnYWxsJyxcbiAgICBtaW5TaXplOiAxMDAwMCxcbiAgICBtaW5DaHVua3M6IDEsXG4gICAgbWF4QXN5bmNSZXF1ZXN0czogNSxcbiAgICBtYXhJbml0aWFsUmVxdWVzdHM6IDUsXG4gICAgYXV0b21hdGljTmFtZURlbGltaXRlcjogJ34nLFxuICAgIG5hbWU6IHRydWUsXG4gICAgY2FjaGVHcm91cHM6IHtcbiAgICAgIHZlbmRvcnM6IHtcbiAgICAgICAgdGVzdDogL1tcXFxcL11ub2RlX21vZHVsZXNbXFxcXC9dLyxcbiAgICAgICAgcHJpb3JpdHk6IC0xMCxcbiAgICAgICAgY2h1bmtzOiAnYWxsJyxcbiAgICAgIH0sXG4gICAgICBkZWZhdWx0OiB7XG4gICAgICAgIG1pbkNodW5rczogMixcbiAgICAgICAgcHJpb3JpdHk6IC0yMCxcbiAgICAgICAgcmV1c2VFeGlzdGluZ0NodW5rOiB0cnVlLFxuICAgICAgfSxcbiAgICB9LFxuICB9XG5cbiAgbGV0IGV4dHJhY2tDU1NDaHVua3MgPSBuZXcgRXh0cmFjdENzc0NodW5rcyh7XG4gICAgZmlsZW5hbWU6ICdbbmFtZV0uW2NodW5rSGFzaDo4XS5jc3MnLFxuICAgIGNodW5rRmlsZW5hbWU6ICdbaWRdLltjaHVua0hhc2g6OF0uY3NzJyxcbiAgfSlcblxuICBpZiAoIWNvbmZpZy5leHRyYWN0Q3NzQ2h1bmtzKSB7XG4gICAgc3BsaXRDaHVua3MuY2FjaGVHcm91cHMgPSB7XG4gICAgICBzdHlsZXM6IHtcbiAgICAgICAgbmFtZTogJ3N0eWxlcycsXG4gICAgICAgIHRlc3Q6IC9cXC5jc3MkLyxcbiAgICAgICAgY2h1bmtzOiAnYWxsJyxcbiAgICAgICAgZW5mb3JjZTogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfVxuICAgIGV4dHJhY2tDU1NDaHVua3MgPSBuZXcgRXh0cmFjdENzc0NodW5rcyh7XG4gICAgICBmaWxlbmFtZTogJ1tuYW1lXS5bY2h1bmtIYXNoOjhdLmNzcycsXG4gICAgfSlcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgbW9kZTogJ3Byb2R1Y3Rpb24nLFxuICAgIGNvbnRleHQ6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLi8uLi9ub2RlX21vZHVsZXMnKSxcbiAgICBlbnRyeTogY29uZmlnLmRpc2FibGVSdW50aW1lXG4gICAgICA/IHBhdGgucmVzb2x2ZShST09ULCBjb25maWcuZW50cnkpXG4gICAgICA6IFtcbiAgICAgICAgICByZXF1aXJlLnJlc29sdmUoJy4uLy4uL2Jvb3RzdHJhcFBsdWdpbnMnKSxcbiAgICAgICAgICByZXF1aXJlLnJlc29sdmUoJy4uLy4uL2Jvb3RzdHJhcFRlbXBsYXRlcycpLFxuICAgICAgICAgIHJlcXVpcmUucmVzb2x2ZSgnLi4vLi4vYm9vdHN0cmFwQXBwJyksXG4gICAgICAgIF0sXG4gICAgb3V0cHV0OiB7XG4gICAgICBmaWxlbmFtZTogJ1tuYW1lXS5baGFzaDo4XS5qcycsIC8vIGRvbnQgdXNlIGNodW5raGFzaCwgaXRzIG5vdCBhIGNodW5rXG4gICAgICBjaHVua0ZpbGVuYW1lOiAndGVtcGxhdGVzL1tuYW1lXS5bY2h1bmtIYXNoOjhdLmpzJyxcbiAgICAgIHBhdGg6IEFTU0VUUyxcbiAgICAgIHB1YmxpY1BhdGg6IHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19BU1NFVFNfUEFUSCB8fCAnLycsXG4gICAgfSxcbiAgICBvcHRpbWl6YXRpb246IHtcbiAgICAgIHNpZGVFZmZlY3RzOiB0cnVlLFxuICAgICAgbWluaW1pemU6IHRydWUsXG4gICAgICBtaW5pbWl6ZXI6IFtcbiAgICAgICAgbmV3IFRlcnNlclBsdWdpbih7XG4gICAgICAgICAgY2FjaGU6IHRydWUsXG4gICAgICAgICAgcGFyYWxsZWw6IHRydWUsXG4gICAgICAgICAgZXhjbHVkZTogL1xcLm1pblxcLmpzLyxcbiAgICAgICAgICAuLi5jb25maWcudGVyc2VyLFxuICAgICAgICAgIHNvdXJjZU1hcDpcbiAgICAgICAgICAgIGNvbmZpZy5wcm9kdWN0aW9uU291cmNlTWFwcyB8fCBjb25maWcudGVyc2VyLnNvdXJjZU1hcCB8fCBkZWJ1ZyxcbiAgICAgICAgICB0ZXJzZXJPcHRpb25zOiB7XG4gICAgICAgICAgICBpZTg6IGZhbHNlLFxuICAgICAgICAgICAgLi4uY29uZmlnLnRlcnNlci50ZXJzZXJPcHRpb25zLFxuICAgICAgICAgICAgbWFuZ2xlOiB7IHNhZmFyaTEwOiB0cnVlLCAuLi5jb25maWcudGVyc2VyLnRlcnNlck9wdGlvbnMubWFuZ2xlIH0sXG4gICAgICAgICAgICBwYXJzZTogeyBlY21hOiA4LCAuLi5jb25maWcudGVyc2VyLnRlcnNlck9wdGlvbnMucGFyc2UgfSxcbiAgICAgICAgICAgIGNvbXByZXNzOiB7IGVjbWE6IDUsIC4uLmNvbmZpZy50ZXJzZXIudGVyc2VyT3B0aW9ucy5jb21wcmVzcyB9LFxuICAgICAgICAgICAgb3V0cHV0OiB7IGVjbWE6IDUsIC4uLmNvbmZpZy50ZXJzZXIudGVyc2VyT3B0aW9ucy5vdXRwdXQgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICAgbmV3IE9wdGltaXplQ1NTQXNzZXRzUGx1Z2luKHt9KSxcbiAgICAgIF0sXG4gICAgICBzcGxpdENodW5rcyxcbiAgICB9LFxuICAgIHBlcmZvcm1hbmNlOiB7XG4gICAgICBtYXhFbnRyeXBvaW50U2l6ZTogMzAwMDAwLFxuICAgIH0sXG4gICAgbW9kdWxlOiB7XG4gICAgICBydWxlczogcnVsZXMoeyBjb25maWcsIHN0YWdlOiAncHJvZCcsIGlzTm9kZTogZmFsc2UgfSksXG4gICAgICBzdHJpY3RFeHBvcnRQcmVzZW5jZTogdHJ1ZSxcbiAgICB9LFxuICAgIHJlc29sdmU6IHtcbiAgICAgIG1vZHVsZXM6IFtcbiAgICAgICAgTk9ERV9NT0RVTEVTLFxuICAgICAgICBTUkMsXG4gICAgICAgIERJU1QsXG4gICAgICAgIC4uLltOT0RFX01PRFVMRVMsIFNSQywgRElTVF0ubWFwKGQgPT5cbiAgICAgICAgICBESVNULnN0YXJ0c1dpdGgoUk9PVCkgPyBwYXRoLnJlbGF0aXZlKF9fZGlybmFtZSwgZCkgOiBwYXRoLnJlc29sdmUoZClcbiAgICAgICAgKSxcbiAgICAgICAgJ25vZGVfbW9kdWxlcycsXG4gICAgICBdLFxuICAgICAgZXh0ZW5zaW9uczogWycud2FzbScsICcubWpzJywgJy5qcycsICcuanNvbicsICcuanN4J10sXG4gICAgICBhbGlhczoge1xuICAgICAgICByZWFjdDogcmVzb2x2ZUZyb20oY29uZmlnLnBhdGhzLk5PREVfTU9EVUxFUywgJ3JlYWN0JyksXG4gICAgICAgICdyZWFjdC1kb20nOiByZXNvbHZlRnJvbShjb25maWcucGF0aHMuTk9ERV9NT0RVTEVTLCAncmVhY3QtZG9tJyksXG4gICAgICAgICdyZWFjdC11bml2ZXJzYWwtY29tcG9uZW50JzogcmVzb2x2ZUZyb20oXG4gICAgICAgICAgX19kaXJuYW1lLFxuICAgICAgICAgICdyZWFjdC11bml2ZXJzYWwtY29tcG9uZW50J1xuICAgICAgICApLFxuICAgICAgfSxcbiAgICB9LFxuICAgIGV4dGVybmFsczogW10sXG4gICAgdGFyZ2V0OiB1bmRlZmluZWQsXG4gICAgcGx1Z2luczogW1xuICAgICAgbmV3IHdlYnBhY2suRW52aXJvbm1lbnRQbHVnaW4ocHJvY2Vzcy5lbnYpLFxuICAgICAgZXh0cmFja0NTU0NodW5rcyxcbiAgICAgIG5ldyBDYXNlU2Vuc2l0aXZlUGF0aHNQbHVnaW4oKSxcbiAgICAgIGFuYWx5emUgJiYgbmV3IEJ1bmRsZUFuYWx5emVyUGx1Z2luKCksXG4gICAgXS5maWx0ZXIoZCA9PiBkKSxcbiAgICBkZXZ0b29sOiBkZWJ1ZyB8fCBjb25maWcucHJvZHVjdGlvblNvdXJjZU1hcHMgPyAnc291cmNlLW1hcCcgOiBmYWxzZSxcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbihzdGF0ZSkge1xuICBjb25zdCB7XG4gICAgc3RhZ2UsXG4gICAgY29uZmlnOiB7IHBhdGhzIH0sXG4gIH0gPSBzdGF0ZVxuXG4gIGNvbnN0IHJlc3VsdCA9IGNvbW1vbihzdGF0ZSlcbiAgaWYgKHN0YWdlICE9PSAnbm9kZScpIHJldHVybiByZXN1bHRcblxuICAvLyBOb2RlIG9ubHkhISFcbiAgcmVzdWx0Lm91dHB1dC5maWxlbmFtZSA9ICdzdGF0aWMtYXBwLmpzJ1xuICByZXN1bHQub3V0cHV0LnBhdGggPSBwYXRocy5BUlRJRkFDVFNcbiAgcmVzdWx0Lm91dHB1dC5saWJyYXJ5VGFyZ2V0ID0gJ3VtZCdcbiAgcmVzdWx0Lm9wdGltaXphdGlvbi5taW5pbWl6ZSA9IGZhbHNlXG4gIHJlc3VsdC5vcHRpbWl6YXRpb24ubWluaW1pemVyID0gW11cbiAgcmVzdWx0LnRhcmdldCA9ICdub2RlJ1xuICByZXN1bHQuZGV2dG9vbCA9IGZhbHNlXG4gIHJlc3VsdC5leHRlcm5hbHMgPSBbXG4gICAgbmV3IFJlZ0V4cChgJHtwYXRocy5QTFVHSU5TfWApLFxuICAgIChjb250ZXh0LCByZXF1ZXN0LCBjYWxsYmFjaykgPT4ge1xuICAgICAgY29uc3QgcmVzb2x2ZWQgPSBwYXRoLnJlc29sdmUoY29udGV4dCwgcmVxdWVzdClcbiAgICAgIGlmIChcbiAgICAgICAgWy9yZWFjdC1zdGF0aWNcXC9saWJcXC9icm93c2VyLywgL3dlYnBhY2stZmx1c2gtY2h1bmtzL10uc29tZShkID0+XG4gICAgICAgICAgZC50ZXN0KHJlc29sdmVkKVxuICAgICAgICApXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIGBjb21tb25qcyAke3Jlc29sdmVkfWApXG4gICAgICB9XG4gICAgICBjYWxsYmFjaygpXG4gICAgfSxcbiAgICBub2RlRXh0ZXJuYWxzKCksXG4gIF1cbiAgcmVzdWx0Lm1vZHVsZS5ydWxlcyA9IHJ1bGVzKHN0YXRlKVxuICByZXN1bHQucGx1Z2lucyA9IFtcbiAgICBuZXcgd2VicGFjay5FbnZpcm9ubWVudFBsdWdpbihwcm9jZXNzLmVudiksXG4gICAgbmV3IENhc2VTZW5zaXRpdmVQYXRoc1BsdWdpbigpLFxuICAgIG5ldyB3ZWJwYWNrLm9wdGltaXplLkxpbWl0Q2h1bmtDb3VudFBsdWdpbih7XG4gICAgICBtYXhDaHVua3M6IDEsXG4gICAgfSksXG4gIF1cbiAgcmV0dXJuIHJlc3VsdFxufVxuIl19